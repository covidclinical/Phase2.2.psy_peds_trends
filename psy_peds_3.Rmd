---
title: "Hospitalizations for psychiatric conditions among adolescents during the COVID-19 pandemic"
output:
  html_document:
    code_folding: show
    toc: yes
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r libraries, message=FALSE, warning=FALSE, results='hide'}
# Install packages
paket <- function(pak){
  new_pak <- pak[!(pak %in% rownames(installed.packages()))]
  if (length(new_pak)) 
    install.packages(new_pak, dependencies = TRUE,repos="https://cloud.r-project.org/")
  sapply(pak, library, character.only = TRUE)
}

listOfPackages <- c("tidyverse", "RColorBrewer", "knitr", "kableExtra", "tsModel", "gridExtra", "dplyr")
paket(listOfPackages)
```

# R session information

```{r}
sessionInfo()
```

```{r}
# options(repr.plot.width = 18, repr.plot.height = 9)
theme_plots <- theme_bw() +
  theme(strip.text = element_text(size = 5),
        axis.text.x = element_text(size = 8), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 10),
        plot.subtitle = element_text(size = 9, face = "italic")) 
theme_set(theme_plots)

# Colorblind palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

# Inclusion criteria

The inclusion criteria for this study is:

-   Patients inclusion criteria:

    -   Age between 11-17 at the date of visit

-   Visits inclusion criteria:

    -   Inpatients (at least one hospitalization \> 1 day)

    -   Start date: January 1st, 2019

    -   End date: May 31st, 2021

    -   Comprising at least one ICD-10 code during hospitalization

# Variables that need to be checked/modified by each site

Change the values of the following variables according to the
specificities of your site:

1.  "folder_4ce_files": folder path where your phase 2.2 data files are
    located

2.   "obfuscation": determine the obfuscation threshold (FALSE if no
    obfuscation, or the numeric value of the obfuscation threshold if
    any)

3.   "raceAvailable": set as TRUE or FALSE depending on whether the
    variable is being collected at your site

4.   "dateFormat": specify the format of the date at your site (e.g., for
    "03-AUG-20", the format would be "%d-%b-%y", [see
    documentation](https://www.stat.berkeley.edu/~s133/dates.html))

```{r message=FALSE, warning=FALSE}
folder_4ce_files <- "Input/09212021_2/"
obfuscation =  FALSE
#obfuscation = 3
raceAvailable = TRUE
#raceAvailable = FALSE
dateFormat <- "%d-%b-%y"
min_hosp_days <- 2
data_update_date <- "2021-06-05"
```

```{r}
# cut-off dates used in the analysis, these should not be changed
history_start_date <- "2019-01-01"
history_end_date <- "2021-05-31"
pandemic_start_date <- "2020-03-15"
start_date_plots <- "2019-01-15"
end_date_plots <- "2021-05-01"
```

# Data input

We will use as input the 2.2 data files. Specifically: 

- LocalPatientSummary 

- LocalPatientObservation 

- LocalPatientClinicalcourse

For sites recording the race, we will also use an additional file: 

- LocalPatientRace

## Read csv files

### 4CE phase 2.2 files

```{r message=FALSE, warning=FALSE}
### Read the CSV input files
source("R/readInputFiles.R")


files <- readInputFiles( path      = folder_4ce_files, 
                         separator = ",",
                         skip      = 0, 
                         verbose   = FALSE )
  
## Create the output folder if it doesn't exist
#if (! "output" %in% list.dirs()) dir.create("output")

### Extract the patient summary and observation information. 
demo_raw <- files[["patientSummary"]] %>% filter(cohort == "AllAdm")
obs_raw <- files[["patientObservations"]] %>% filter(cohort == "AllAdm")
clinical_raw <- files[["patientClinicalCourse"]] %>% filter(cohort == "AllAdm")

### Read the file containing race information for those sites recording this variable
if( raceAvailable == TRUE ){
  race_raw <- read.delim(file.path(folder_4ce_files, "/LocalPatientRace.csv"), sep = ",", skip = 0)
}
```

### Read the ICD10 codes file

The file containing the ICD10 psychiatric related codes is located in
the `public-data` folder of the GitHub repository.

```{r}
icdCodes <- read.csv("public-data/pediatric_psychiatric_ICD10_codesV2.csv", header = TRUE, colClasses = "character") %>%
   filter( flag %in% c("originalCodes", "FrenchSpecificCodes")) %>%
   dplyr::select( disorder_group, ICD10_Code, description )
```

## Data-management

### Filtering on "inpatient" status

```{r}
# Filtering on inpatients here (in_hospital == 1), to reduce subsequent compute time of the encounter length calculation 
clinical_raw <- filter(clinical_raw, in_hospital == 1)
```

### Calculating duration of individual hospitalizations

Adding columns with hospitalization number and hospitalization length to the clinical raw file

```{r}
count_sequences_hospitalisation <- function(df, ...) {
  seq_hospitalisation_df <- data.frame(total_span = seq(min(df$days_since_admission),
                                                        max(df$days_since_admission))
  ) %>%
    left_join(df, by = c("total_span" = "days_since_admission")) %>%
    replace_na(list(in_hospital = 0))
  count_sequences <- rle(seq_hospitalisation_df$in_hospital)
  count_sequences_1 <- lapply(count_sequences, function(x) x[count_sequences$values == 1])
  n_sequences <- seq_along(count_sequences_1$lengths)
  sequences <- rep.int(n_sequences, count_sequences_1$lengths)
  sequences_len <- rep.int(count_sequences_1$lengths, count_sequences_1$lengths)
  stopifnot(length(df$days_since_admission) == length(sequences))
  data.frame(days_since_admission = df$days_since_admission,
             n_hospitalisation = sequences,
             len_hospitalisation = sequences_len)
}
stopifnot(all(clinical_raw$in_hospital == 1))
hospitalisations_seq_df <- clinical_raw %>%
  distinct(patient_num, cohort, days_since_admission, in_hospital) %>%
  group_by(patient_num, cohort) %>%
  group_modify(count_sequences_hospitalisation)

clinical_raw <- left_join(clinical_raw,
                          hospitalisations_seq_df,
                          by = c("patient_num", "cohort", "days_since_admission"))
```


### Counting ICD10 mental health codes in the obs_raw table

```{r}
### check that the ICD codes follow the regular expression [A-Z][0-9][0-9AB]\.?[0-9A-TV-Z]{0,4}
codesToReview <- obs_raw %>% dplyr::filter(concept_type == "DIAG-ICD10",
                                           ! grepl( "[A-Z][0-9][0-9AB]\\.?[0-9A-TV-Z]{0,4}", concept_code))
print(codesToReview)

### Calculate how many of the mental codes are in the dataset
mentalHealthCodes <- unique( obs_raw %>%
  dplyr::filter( concept_type == "DIAG-ICD10", 
                 concept_code %in% icdCodes$ICD10_Code ) %>%
  dplyr::mutate( concept_code = as.character( concept_code ), 
                 concept_length = nchar( concept_code ), 
                 concept_check = ifelse( concept_length == 4 | concept_length > 8, "Check", "OK")) %>%
  dplyr::select( concept_code, concept_length, concept_check) )

summary(as.factor( mentalHealthCodes$concept_check ) )

print( paste0("There are ", length(mentalHealthCodes$concept_code), " ICD10 mental codes out of the total ",length(unique(icdCodes$ICD10_Code)), " in the dataset"))
```

## Applying inclusion criteria to filter and format the data

We are selecting hospitalizations based on the following criteria:

- Associated with at least 1 ICD code

- With a duration of hospitalization spanning over at least two consecutive days 

- Starting on or after 2019/01/01

### Calculating age at hospitalization time
```{r}
# Calculating patient age at the time of visit, assuming the age used is the patients' age at the time of extraction (last discharge date available in the data)
obs_raw_age <- left_join(obs_raw, demo_raw[c("patient_num", "age")], by = c("patient_num")) %>% 
  left_join(clinical_raw[, c("patient_num", "days_since_admission", "calendar_date")], 
            by = c("patient_num", "days_since_admission"))
stopifnot(nrow(obs_raw_age) == nrow(obs_raw))
obs_raw_age$age_time_diagnosis <- obs_raw_age$age - floor(as.numeric(as.Date(data_update_date) - as.Date(obs_raw_age$calendar_date, dateFormat)) / 365.25)
```


``` {r}
obs_filtered_age <- obs_raw_age %>% 
  filter(concept_type == 'DIAG-ICD10', 
         days_since_admission >= 0)

clinical_filtered <- clinical_raw %>%
  filter( len_hospitalisation > min_hosp_days, 
          cohort  %in% c("AllAdm")) %>%
  dplyr::mutate( date = as.Date( calendar_date, format = dateFormat ),
                 weeks = as.Date(cut( date, breaks = "week")),
                 month = as.Date(cut( date, breaks = "month")),
                 year = format( date, "%Y"), 
                 period = ifelse( date < pandemic_start_date,
                                  "before_pandemic", "during_pandemic"))
```

```{r}
# Steps necessary to filter rows:
  # - encounters without ICD
  # - ICD diagnosed outside of encounters
  # - patients from the patients table that don't have any encounters matching the criteria
clinical_table <- clinical_filtered %>% 
  inner_join( distinct(obs_filtered_age, patient_num, days_since_admission),  by = c("patient_num", "days_since_admission")) %>% 
  distinct(patient_num, n_hospitalisation) %>% 
  inner_join(clinical_filtered, by = c("patient_num", "n_hospitalisation"))
# Adding new columns
observation_table <- obs_filtered_age %>% 
  inner_join(clinical_table[, c("patient_num", "days_since_admission")], by = c("patient_num", "days_since_admission"))
demographic_table <- demo_raw %>% 
  inner_join(distinct(clinical_table, patient_num), by = "patient_num")
all_codes <- observation_table %>% 
   inner_join(clinical_table, by = c("patient_num", "days_since_admission")) %>% 
   inner_join(demographic_table[, c("patient_num", "sex")], by = "patient_num")
```

```{r}
stopifnot(unique(all_codes$cohort) == "AllAdm")
stopifnot(unique(all_codes$in_hospital) == 1)
stopifnot(unique(all_codes$len_hospitalisation > min_hosp_days))
stopifnot(nrow(all_codes) == nrow(observation_table))
stopifnot(length(unique(all_codes$patient_num)) == length(unique(demographic_table$patient_num)))
stopifnot(length(unique(all_codes$patient_num)) == length(unique(observation_table$patient_num)))
stopifnot(length(unique(all_codes$patient_num)) == length(unique(clinical_table$patient_num)))
stopifnot(nrow(distinct(all_codes, patient_num, n_hospitalisation)) == nrow(distinct(clinical_table, patient_num, n_hospitalisation)))
stopifnot(nrow(distinct(all_codes, patient_num, days_since_admission)) == nrow(distinct(observation_table, patient_num, days_since_admission)))
```

## First estimation: total number of patients without filtering by any disease subtype


```{r}
admission_plot_count <- function(df,
                               x,
                               y, 
                               title,
                               y_title,
                               size = NULL, 
                               color = NULL){
  plot <- ggplot(df, aes_string(x = x, y = y, color = color, size = size))  +
    geom_point() +
    scale_x_date(date_breaks = "1 month", date_labels =  "%b %Y", limits = c(start_date_plots, end_date_plots), expand = expansion(mult = 0.01, add = 1)) +
    theme(axis.text.x=element_text(angle=60, hjust=1))+
    labs(x = "Calendar date",
         y = y_title, 
       title = title) 
  return(plot)
}

```

### New hospitalizations

```{r}

new_hospitalizations_per_week <- clinical_table %>%
  group_by(patient_num, n_hospitalisation) %>%
  slice(which.min(weeks)) %>%
  filter( in_hospital == 1 ) %>%
    group_by( weeks ) %>%
  summarise(count = n_distinct(patient_num)) %>% 
  ungroup()


start_date_plots <- as.Date("2019-01-01")
end_date_plots <- as.Date("2021-05-24")

nh_week <- admission_plot_count(df = new_hospitalizations_per_week, 
                     x = "weeks",
                     y = "count", 
                     title = "New admissions (per week)", 
                     y_title = "Patient Count")

nh_week
```




### Filtering on age at hospitalization time

Keeping only patients with age between 11 and 17

```{r}

# Filtering hospitalizations where patient age is in inclusion criteria
observation_table_ado <- filter(observation_table, age_time_diagnosis >= 11 & age_time_diagnosis <= 17)

# Filtering observation tables which patient_num and days_since_admission are still in clinical table after filtering on age

clinical_test <- clinical_table[, c("patient_num", "n_hospitalisation", "days_since_admission")] %>% 
  inner_join(distinct(observation_table_ado, patient_num, days_since_admission, age_time_diagnosis), 
            by = c("patient_num", "days_since_admission"))

clinical_table_ado <- clinical_table %>% 
  inner_join(clinical_test[, c("patient_num", "n_hospitalisation", "age_time_diagnosis")],
             by = c("patient_num", "n_hospitalisation"))
  
observation_table_ado <- clinical_table %>% 
  inner_join(observation_table[, c("patient_num", "days_since_admission")], 
             by = c("patient_num", "days_since_admission"))

# Filtering observation tables which patient_num are still in clinical table after filtering on age
demographic_table_ado <- demographic_table %>% 
  inner_join(distinct(clinical_table_ado, patient_num), by = "patient_num")

all_codes_ado <- all_codes %>% 
   filter(age_time_visit >= 11 & age_time_visit <= 17)

head(observation_table_ado)
head(clinical_table_ado)
head(all_codes_ado)
```


```{r}
stopifnot(unique(all_codes_ado$cohort) == "AllAdm")
stopifnot(unique(all_codes_ado$in_hospital) == 1)
stopifnot(unique(all_codes_ado$len_hospitalisation > min_hosp_days))
stopifnot(nrow(all_codes_ado) == nrow(observation_table_ado))
stopifnot(length(unique(all_codes_ado$patient_num)) == length(unique(demographic_table_ado$patient_num)))
stopifnot(length(unique(all_codes_ado$patient_num)) == length(unique(observation_table_ado$patient_num)))
stopifnot(length(unique(all_codes_ado$patient_num)) == length(unique(clinical_table_ado$patient_num)))
stopifnot(nrow(distinct(all_codes_ado, patient_num, n_hospitalisation)) == nrow(distinct(clinical_table_ado, patient_num, n_hospitalisation)))
stopifnot(nrow(distinct(all_codes_ado, patient_num, days_since_admission)) == nrow(distinct(observation_table_ado, patient_num, days_since_admission)))
```


```{r}

# Steps necessary to filter rows:
  # - encounters without ICD
  # - ICD diagnosed outside of encounters
  # - patients from the patients table that don't have any encounters matching the criteria
clinical_table <- clinical_filtered %>% 
  inner_join( distinct(obs_filtered, patient_num, days_since_admission),  by = c("patient_num", "days_since_admission")) %>% 
  distinct(patient_num, n_hospitalisation) %>% 
  inner_join(clinical_filtered, by = c("patient_num", "n_hospitalisation"))
# Adding new columns
observation_table <- obs_filtered %>% 
  inner_join(clinical_table[, c("patient_num", "days_since_admission")], by = c("patient_num", "days_since_admission"))
demographic_table <- demo_raw %>% 
  inner_join(distinct(clinical_table, patient_num), by = "patient_num")
all_codes <- observation_table %>% 
   inner_join(clinical_table, by = c("patient_num", "days_since_admission")) 
#%>% 
#   inner_join(dplyr::select(demographic_table, -days_since_admission), by = c("patient_num"))

```


### Total hospitalize patients

```{r, fig.height=12, fig.width=12}
total_hospitalizations_per_day <- clinical_filtered %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( date ) %>%
  summarise(count = n_distinct(patient_num))

unique_patients_hospitalized_per_week <- clinical_filtered %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks ) %>%
  summarise(count = n_distinct(patient_num))

unique_patients_hospitalized_per_month <- clinical_filtered %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( month ) %>%
  summarise(count = n_distinct(patient_num))


th_day <- ggplot(total_hospitalizations_per_day, aes(x = date,
                       y = count))  +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels =  "%b %Y") +
  theme(axis.text.x=element_text(angle=60, hjust=1))+
  labs(x = "Calendar date",
       y = "Patients count", 
       title = "Currently hospitalized patients (per day)")

th_week <- ggplot(unique_patients_hospitalized_per_week, aes(x = weeks,
                       y = count))  +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels =  "%b %Y") +
  theme(axis.text.x=element_text(angle=60, hjust=1))+
  labs(x = "Calendar date",
       y = "Patients count", 
       title = "Currently hospitalized patients (per week)")

th_month <- ggplot(unique_patients_hospitalized_per_month, aes(x = month,
                       y = count))  +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels =  "%b %Y") +
  theme(axis.text.x=element_text(angle=60, hjust=1))+
  labs(x = "Calendar date",
       y = "Patients count", 
       title = "Currently hospitalized patients (per month)")

require(gridExtra)
grid.arrange(th_day, th_week, th_month, ncol=1)
```

#### Group by sex

#### Per week

```{r}
# counts per week and sex
patients_hospitalized_per_week_agg_sex <- clinical_filtered %>%
  filter(date < end_date_plots &
         date >= start_date_plots & 
           sex %in% c("female", "male")) %>%
    group_by( weeks, sex ) %>%
  summarise(count_sex = n_distinct(patient_num))

# the total counts per week was estimated before: unique_patients_hospitalized_per_week
patients_hospitalized_per_week_agg_sex_perc <- unique_patients_hospitalized_per_week %>%
  left_join( patients_hospitalized_per_week_agg_sex, by = c("weeks")) %>% 
  replace_na(list(count_sex = 0))

patients_hospitalized_per_week_agg_sex_perc$percentage <- 100*patients_hospitalized_per_week_agg_sex_perc$count_sex/patients_hospitalized_per_week_agg_sex_perc$count

patients_hospitalized_per_week_agg_sex %>%
  ggplot(aes(x = weeks, y = count_sex, fill = sex)) +
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = cbPalette) +
  labs(y = "Counts",
       x = "Week",
       title = "Weekly patient counts aggregated by sex",
       subtitle = "Per Sex") + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=sex), colour= "black", size = 0.5)

patients_hospitalized_per_week_agg_sex_perc %>%
  ggplot(aes(x = weeks, y = percentage, fill = sex)) +
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = cbPalette) +
  labs(y = "Percentage",
       x = "Week",
       title = "Weekly patient (%) aggregated by sex",
       subtitle = "Per Sex") + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=sex), colour= "black", size = 0.5)
```

## Second estimation: total number of patients filtering by psychiatric disorders

## Creating the inputTable

Creation of the inputTable that will be the only table used throughout
the rest of the analysis - selecting only visits with at least one ICD
codes pertaining to the mental health categories - filter visits where
patients are between 11 and 17 years old - add the demographic and
hospitalization related information - add the ICD code description and
the related disorder group

### Add the psychiatric/mental health ICD code description and filter

```{r message=FALSE, warning=FALSE}
# Getting site name, will be used later in the analysis
site <- unique(as.character(demo_raw$siteid))

icdCategory <- read.delim("public-data/icd10Codes.txt",
                          header = FALSE,
                          colClasses = "character")
colnames(icdCategory) <- c("icd_code_letter", "icd_description_category")

all_codes_desc <- all_codes %>% 
    left_join( icdCodes, by=c("concept_code" = "ICD10_Code") ) %>%
  mutate(icd_code_category = ifelse(concept_code %in% icdCodes$ICD10_Code, 
                               "psy", 
                               "others")) %>%
  dplyr::select( patient_num, sex, age_time_visit, concept_type, concept_code, calendar_date,
                 in_hospital, n_hospitalisation, len_hospitalisation, date, weeks, month, year,
                 period, disorder_group, description, icd_code_category )

all_codes_desc <- all_codes_desc %>% 
  mutate( icd_code_letter = ifelse(substr(concept_code, 1, 1) %in% c("D", "H"), substr(concept_code, 1, 2), substr(concept_code, 1, 1) ))

all_codes_desc <- left_join( all_codes_desc, icdCategory) %>%
  mutate( icd_description_category = replace_na( ifelse( concept_code %in% icdCodes$ICD10_Code, "Psy", icd_description_category), "Others")) 
all_codes_psy <- all_codes_desc %>% 
  filter(concept_code %in% icdCodes$ICD10_Code)

if( raceAvailable == TRUE ){
  all_codes_psy <- all_codes_psy %>%
    left_join( race_raw, by = c("patient_num") )
}
```

### Aggregated by sex

```{r}
# counts per week and sex
patients_hospitalized_per_week_agg_sex <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots & 
           sex %in% c("female", "male")) %>%
    group_by( weeks, sex ) %>%
  summarise(count_sex = n_distinct(patient_num))

patients_hospitalized_per_week_agg_sex %>%
  ggplot(aes(x = weeks, y = count_sex, fill = sex)) +
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = cbPalette) +
  labs(y = "Counts",
       x = "Week",
       title = "Weekly patient counts aggregated by sex",
       subtitle = "Per Sex") + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=sex), colour= "black", size = 0.5)

##percentage
total_patients_psy_per_week <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks ) %>%
  summarise(count = n_distinct(patient_num))

patients_hospitalized_per_week_agg_sex_perc <- total_patients_psy_per_week %>%
  left_join( patients_hospitalized_per_week_agg_sex, by = c("weeks")) %>% 
  replace_na(list(count_sex = 0))

patients_hospitalized_per_week_agg_sex_perc$percentage <- 100*patients_hospitalized_per_week_agg_sex_perc$count_sex/patients_hospitalized_per_week_agg_sex_perc$count

patients_hospitalized_per_week_agg_sex_perc %>%
  ggplot(aes(x = weeks, y = percentage, fill = sex)) +
  geom_bar(stat="identity", position = "dodge")+
  scale_fill_manual(values = cbPalette) +
  labs(y = "Percentage ",
       x = "Week",
       title = "Weekly patient (%) aggregated by sex",
       subtitle = "Per Sex") + 
  theme(legend.position = "bottom") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=sex), colour= "black", size = 0.5)


```

#### Psychiatric related conditions vs. any other condition

##### New admissions

##### Total hospitalizations

We have estimated the total number of hospitalizations in the previous
steps: - total_hospitalization_per_day - total_hospitalization_per_week
- total_hospitalization_per_month

We will use these counts to estimate the percentage and to compare total
counts, vs psychiatric related conditions.

```{r}
count_icd_per_day_psy <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( date ) %>%
  summarise(count_psy = n_distinct(patient_num)) %>%
  mutate( period = ifelse( date < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

count_icd_per_day <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( date ) %>%
  summarise(count_icd = n_distinct(patient_num)) %>%
  mutate( period = ifelse( date < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

count_icd_per_day <- count_icd_per_day %>%
  left_join(count_icd_per_day_psy, 
            by = c("date", "period")) %>% 
  replace_na(list(count_psy = 0))

count_icd_per_day$percentage_psy <- 100*count_icd_per_day$count_psy / count_icd_per_day$count_icd


thpd_psyPer <- count_icd_per_day %>%
  ggplot(aes(x = date, y = percentage_psy, fill = period)) +
  scale_fill_manual(values = cbPalette[c(3,4)]) +
  labs(y = "Percentage",
       x = "Date (by day)",
       title = "Percentage of patients with mental health related ICD codes (daily)") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)+
  geom_point()
thpd_psyPer


count_icd_per_day %>%
  ggplot(aes(x = date, y = percentage_psy, fill = period)) +
  scale_fill_manual(values = cbPalette[c(3,4)]) +
  labs(y = "Percentage",
       x = "Date (by day)",
       title = "Percentage of patients with mental health related ICD codes (daily)") + 
  geom_point()
  #geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)
```

By week

```{r}
count_icd_per_week_psy <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks ) %>%
  summarise(count_psy = n_distinct(patient_num)) %>%
  mutate( period = ifelse( weeks < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

count_icd_per_week <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks ) %>%
  summarise(count_icd = n_distinct(patient_num)) %>%
  mutate( period = ifelse( weeks < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

count_icd_per_week <- count_icd_per_week %>%
  left_join(count_icd_per_week_psy, 
            by = c("weeks", "period")) %>% 
  replace_na(list(count_psy = 0))

count_icd_per_week$percentage_psy <- 100*count_icd_per_week$count_psy / count_icd_per_week$count_icd


thpd_psyPer <- count_icd_per_week %>%
  ggplot(aes(x = weeks, y = percentage_psy, fill=period)) +
  scale_fill_manual(values = cbPalette[c(3,4)]) +
  labs(y = "Percentage",
       x = "Date (by week)",
       title = "Percentage of patients with mental health related ICD codes (weekly)") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)+
  geom_point()
thpd_psyPer


count_icd_per_week %>%
  ggplot(aes(x = weeks, y = percentage_psy, fill = period)) +
  scale_fill_manual(values = cbPalette[c(3,4)]) +
  labs(y = "Percentage",
       x = "Date (by week)",
       title = "Percentage of patients with mental health related ICD codes (weekly)") + 
  geom_point()
  #geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)
```

# Per day

```{r}
thpd_psyCount <- count_icd_per_day %>%
  pivot_longer(names_to = "counts", cols=c(count_psy, count_icd)) %>%
  mutate( counts = ifelse( counts == "count_psy", "Psy", "Total")) %>%
  ggplot(aes(x = date, y = value, fill = counts, color = counts)) +
  geom_point() +
  # geom_line() +
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  scale_fill_manual(values = cbPalette) +
  scale_color_manual(values = cbPalette) +
  labs(y = "Counts",
       x = "Date (by day)",
       title = "Daily patient counts with mental health related ICD codes") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)
thpd_psyCount

```

# Per week

```{r}
thpd_psyCount <- count_icd_per_week %>%
  pivot_longer(names_to = "counts", cols=c(count_psy, count_icd)) %>%
  mutate( counts = ifelse( counts == "count_psy", "Psy", "Total")) %>%
  ggplot(aes(x = weeks, y = value, fill = counts, color = counts)) +
  geom_point() +
  # geom_line() +
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  scale_fill_manual(values = cbPalette) +
  scale_color_manual(values = cbPalette) +
  labs(y = "Counts",
       x = "Date (by week)",
       title = "Weekly patient counts with mental health related ICD codes") + 
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)
thpd_psyCount

```

We will compare the psychiatric conditions with some other disorders
(e.g, digestive, respiratory, etc.) We will use these counts to estimate
the percentage and to compare total counts, vs psychiatric related
conditions.

```{r}
total_hospitalizations_per_day_disorder_group <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots & 
        icd_description_category %in% c("Psy","Neoplams","Diseases of the respiratory system","Diseases of the digestive system" ))%>%
    group_by( date, icd_description_category ) %>%
  summarise(counts = n_distinct(patient_num))

thpd_disorderGroup <- total_hospitalizations_per_day_disorder_group %>%
  ggplot(aes(x = date, y = counts, fill = icd_description_category, color = icd_description_category)) +
  #geom_point(alpha=0.2) +
  geom_line() +
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  scale_fill_manual(values = cbPalette) +
  scale_color_manual(values = cbPalette) +
  labs(y = "patient number",
       x = "days",
       title = "Total number of hospitalized patients (daily)") +   
  theme(axis.text.x = element_text(angle=45, vjust = 1, hjust=1), legend.position = "bottom", legend.text = element_text(size=7), legend.title = element_text(size=7) ) +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se = TRUE, aes(colour=period), colour= "black", size = 0.5)
thpd_disorderGroup
```

#### Psychiatric conditions aggregating by suptype

##### New admissions

##### Total hospitalizations

We estimate and plot the counts per disorder group.

Per day

```{r}
count_disorder_group_per_day <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( date, disorder_group ) %>%
  summarise(count_dg = n_distinct(patient_num)) %>%
  mutate( period = ifelse( date < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

dg_per_day <- count_disorder_group_per_day %>%  
  ggplot(aes(x = date, y= count_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Days",
       y = "Patient Count",
       title = "Daily patient counts with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dg_per_day
```

Per week

```{r}
count_disorder_group_per_week <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks, disorder_group ) %>%
  summarise(count_dg = n_distinct(patient_num)) %>%
  mutate( period = ifelse( weeks < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

dg_per_week <- count_disorder_group_per_week %>%  
  ggplot(aes(x = weeks, y= count_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Weeks",
       y = "Patient Count",
       title = "Weekly patient counts with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dg_per_week
```

Per month

```{r}
count_disorder_group_per_month <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( month, disorder_group ) %>%
  summarise(count_dg = n_distinct(patient_num)) %>%
  mutate( period = ifelse( month < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

dg_per_month <- count_disorder_group_per_month %>%  
  ggplot(aes(x = month, y= count_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Months",
       y = "Patient Count",
       title = "Monthly patient counts with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dg_per_month
```

Percentage using as denominator total number of patients per day with a
psy disorder.

Per day - Total counts previously estimated (count_icd_per_day_psy). -
Counts per disorder group previously estimated
(count_disorder_group_per_day)

```{r}
# join the total with the disorder group count to estimate the percentage
perc_disorder_group_per_day <- count_icd_per_day_psy %>%
  left_join(count_disorder_group_per_day, 
            by = c("date", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group_per_day$percentage_dg <- 100*perc_disorder_group_per_day$count_dg / perc_disorder_group_per_day$count_psy

dgPerc_per_day <- perc_disorder_group_per_day %>%  
  ggplot(aes(x = date, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Days",
       y = "Patient (%)",
       title = "Percentage of daily patients with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc_per_day
```

Per week - Counts per disorder group previously estimated
(count_disorder_group_per_week)

```{r}
# estimate the weekly counts
count_icd_per_week_psy <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks ) %>%
  summarise(count_psy = n_distinct(patient_num)) %>%
  mutate( period = ifelse( weeks < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

# join the total with the disorder group count to estimate the percentage
perc_disorder_group_per_week <- count_icd_per_week_psy %>%
  left_join(count_disorder_group_per_week, 
            by = c("weeks", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group_per_week$percentage_dg <- 100*perc_disorder_group_per_week$count_dg / perc_disorder_group_per_week$count_psy

dgPerc_per_week <- perc_disorder_group_per_week %>%  
  ggplot(aes(x = weeks, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Weeks",
       y = "Patient (%)",
       title = "Percentage of weekly patients with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc_per_week
```

Months

```{r}
# estimate the monthly counts
count_icd_per_month_psy <- all_codes_psy %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( month ) %>%
  summarise(count_psy = n_distinct(patient_num)) %>%
  mutate( period = ifelse( month < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

# join the total with the disorder group count to estimate the percentage
perc_disorder_group_per_month <- count_icd_per_month_psy %>%
  left_join(count_disorder_group_per_month, 
            by = c("month", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group_per_month$percentage_dg <- 100*perc_disorder_group_per_month$count_dg / perc_disorder_group_per_month$count_psy

dgPerc_per_month <- perc_disorder_group_per_month %>%  
  ggplot(aes(x = month, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Months",
       y = "Patient (%)",
       title = "Percentage of monthly patients with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc_per_month
```

Percentage using as denominator total number of patients

Per day - Counts per disorder group previously estimated
(count_disorder_group_per_day)

```{r}
# estimate the total number per day 
count_icd_per_day <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( date ) %>%
  summarise(count_icd = n_distinct(patient_num)) %>%
  mutate( period = ifelse( date < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

# join the total with the disorder group count to estimate the percentage
perc_disorder_group_per_day <- count_icd_per_day %>%
  left_join(count_disorder_group_per_day, 
            by = c("date", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group_per_day$percentage_dg <- 100*perc_disorder_group_per_day$count_dg / perc_disorder_group_per_day$count_icd

dgPerc_per_day <- perc_disorder_group_per_day %>%  
  ggplot(aes(x = date, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Days",
       y = "Patient (%)",
       title = "Percentage of daily patients with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc_per_day
```

Per week - Counts per disorder group previously estimated
(count_disorder_group_per_week)

```{r}
# estimate the weekly counts
count_icd_per_week <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( weeks ) %>%
  summarise(count_icd = n_distinct(patient_num)) %>%
  mutate( period = ifelse( weeks < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

# join the total with the disorder group count to estimate the percentage
perc_disorder_group_per_week <- count_icd_per_week %>%
  left_join(count_disorder_group_per_week, 
            by = c("weeks", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group_per_week$percentage_dg <- 100*perc_disorder_group_per_week$count_dg / perc_disorder_group_per_week$count_icd

dgPerc_per_week <- perc_disorder_group_per_week %>%  
  ggplot(aes(x = weeks, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Weeks",
       y = "Patient (%)",
       title = "Percentage of weekly patients with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc_per_week
```

Months

```{r}
# estimate the monthly counts
count_icd_per_month <- all_codes_desc %>%
  filter(date < end_date_plots &
         date >= start_date_plots ) %>%
    group_by( month ) %>%
  summarise(count_icd = n_distinct(patient_num)) %>%
  mutate( period = ifelse( month < pandemic_start_date,
                           "before_pandemic",
                           "during_pandemic")
  )

# join the total with the disorder group count to estimate the percentage
perc_disorder_group_per_month <- count_icd_per_month %>%
  left_join(count_disorder_group_per_month, 
            by = c("month", "period")) %>% 
  replace_na(list(count_dg = 0))

perc_disorder_group_per_month$percentage_dg <- 100*perc_disorder_group_per_month$count_dg / perc_disorder_group_per_month$count_icd

dgPerc_per_month <- perc_disorder_group_per_month %>%  
  ggplot(aes(x = month, y= percentage_dg, fill = period, group = disorder_group )) +
  geom_bar(stat = "identity")+
  geom_vline(xintercept = as.Date(pandemic_start_date),
             linetype = "dashed") +
  geom_smooth(method = "lm", formula = y ~ splines::ns(x, 2), se= TRUE, aes(colour=period), colour= "black", size = 0.5) + 
  labs(x = "Months",
       y = "Patient (%)",
       title = "Percentage of monthly patients with mental health related ICD codes", 
       subtitle = "Grouped by mental health ICD subcategories") + 
  ylim(0, NA) + 
  facet_wrap(. ~ disorder_group, scales = "free_y") +
  theme(strip.text.x = element_text(size = 4),
        axis.text.x = element_text(size = 5, angle = 90), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 12),
        plot.subtitle = element_text(size = 11),
        legend.position = "none") +
  scale_fill_manual(values = cbPalette[-1])

dgPerc_per_month
```
