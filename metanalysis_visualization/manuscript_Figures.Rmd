---
title: "Visualizations for the manuscript"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---


### Installing packages and loading the library

```{r libraries, message=FALSE, warning=FALSE, results='hide'}
# Install packages
paket <- function(pak){
  new_pak <- pak[!(pak %in% rownames(installed.packages()))]
  if (length(new_pak)) 
    install.packages(new_pak, dependencies = TRUE,repos="https://cloud.r-project.org/")
  sapply(pak, library, character.only = TRUE)
}
listOfPackages <- c("plotly", "tidyverse", "tidyr","devtools","RColorBrewer", "knitr", "kableExtra", "tsModel", "gridExtra", "dplyr", "metafor", "meta", "viridis", "UpSetR", "scales", "EHRtemporalVariability", "gmodels", "flextable", "data.table")
paket(listOfPackages)

if (! "ComplexHeatmap" %in% rownames(installed.packages())) install_github("jokergoo/ComplexHeatmap")
if (! "ggh4x" %in% rownames(installed.packages())) install_github("teunbrand/ggh4x")
library( ComplexHeatmap)
library( ggh4x )
```


```{r}
# options(repr.plot.width = 18, repr.plot.height = 9)
theme_plots <- theme_bw() +
  theme(strip.text = element_text(size = 5),
        axis.text.x = element_text(size = 8), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 10),
        plot.subtitle = element_text(size = 9, face = "italic")) 
theme_set(theme_plots)

# Colorblind palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
time_period <-"months" #possible values: days, weeks, months
pandemic_start_date <- as.Date("2020-03-15")
start_date_plots <- as.Date("2019-02-01")
end_date_plots <- as.Date("2021-04-30")
```

## Read the input file by site
Each site shared the aggregated counts results. Putting all the results together. 

```{r}
outputDir <- "../../output/latest_output/"
outputFiles <- list.files( path = outputDir, pattern = "\\.RData")
country_map <- read.delim( file = "../public-data/country_mapping.txt")
```

Put all the aggregated counts from the different sites together
```{r}
for( i in 1:length( outputFiles )){
  print(outputFiles[i])
  load(paste0( outputDir, outputFiles[i]))
  if( i == 1 ){
    patients_hospitalized_agg_sex_perc_all <- patients_hospitalized_agg_sex_perc
    patient_count_psy_period_psy_all <- patient_count_psy_period_psy
    perc_disorder_group_all <- perc_disorder_group
    ratios_patients_with_without_psy_all <- ratios_patients_with_without_psy
    length_hospitalisation_values_all <- length_hospitalisation_values
    mental_codes_qc_output_all <- mental_codes_qc_output %>%
      select( disorder_group, description, concept_code, distinct_patients, distinct_observations, siteid )
    table1_all <- table1
  } else {
    perc_disorder_group_all <- rbind(perc_disorder_group_all, perc_disorder_group)
    patients_hospitalized_agg_sex_perc_all <- rbind( patients_hospitalized_agg_sex_perc_all, patients_hospitalized_agg_sex_perc)
    mental_codes_qc_output_all <- rbind( mental_codes_qc_output_all,
                                         mental_codes_qc_output %>%
                                           select( disorder_group, description, concept_code, distinct_patients, distinct_observations, siteid )
    )
    table1_all <- rbind( table1_all, table1)
    patient_count_psy_period_psy_all <- rbind( patient_count_psy_period_psy_all,patient_count_psy_period_psy)
    ratios_patients_with_without_psy_all <- rbind( ratios_patients_with_without_psy_all, ratios_patients_with_without_psy)
    length_hospitalisation_values_all <- tryCatch(
      rbind(length_hospitalisation_values_all, length_hospitalisation_values),
      error = function(e) length_hospitalisation_values_all
    )
    rm(patients_hospitalized_agg_sex_perc,patient_count_psy_period_psy,
       perc_disorder_group,ratios_patients_with_without_psy,
       patient_count_psy_period_psy_clear, mental_codes_qc_output, table1, length_hospitalisation_values)
  }
}

```

# Filter by dates
```{r}
start_date_plots <- as.Date("2019-02-01")
end_date_plots <- as.Date("2021-04-30")

filter_by_dates <- function(df_,
                            start_date_plot,
                            end_date_plots) {
  df_[df_[["time_p"]] <= end_date_plots & df_[["time_p"]] >= start_date_plots, ]
}

patient_count_psy_period_psy_all <- filter_by_dates(patient_count_psy_period_psy_all, start_date_plots, end_date_plots)
patients_hospitalized_agg_sex_perc_all <- filter_by_dates(patients_hospitalized_agg_sex_perc_all, start_date_plots, end_date_plots)
perc_disorder_group_all <- filter_by_dates(perc_disorder_group_all, start_date_plots, end_date_plots)
ratios_patients_with_without_psy_all <- filter_by_dates(ratios_patients_with_without_psy_all, start_date_plots, end_date_plots)
```

```{r}
# To be able to have one single reference for the mapping between periods, months and months labels
time_timep_df <- distinct(patient_count_psy_period_psy_all[, c("time", "time_p")])
time_timep_list <- time_timep_df[["time_p"]]
names(time_timep_list) <- as.character(time_timep_df[["time"]])
time_timep_list[["29"]] <- as.Date("2021-05-01")
```


```{r}
patient_count_psy_period_psy_all <- patient_count_psy_period_psy_all %>% 
  mutate(count_icd = count_no_psy_patients + count_psy_patients)
patients_hospitalized_agg_sex_perc_all <- left_join(
  patients_hospitalized_agg_sex_perc_all, 
  time_timep_df, 
  by = c("time_p"))
perc_disorder_group_all <- left_join(perc_disorder_group_all, 
                                     time_timep_df, 
                                     by = c("time_p"))
```


# Add site complete name information

```{r}
patient_count_psy_period_psy_all <- left_join(patient_count_psy_period_psy_all, country_map, on = "site_id")
patients_hospitalized_agg_sex_perc_all <- left_join(patients_hospitalized_agg_sex_perc_all, country_map, on = "site_id")
perc_disorder_group_all <- left_join(perc_disorder_group_all, country_map, on = "site_id")
ratios_patients_with_without_psy_all <- left_join(ratios_patients_with_without_psy_all, country_map, on = "site_id")
```

### Table 1

```{r}
total_unique_encounters <- patient_count_psy_period_psy_all %>% 
  group_by(period) %>% 
  summarise(total_unique_encounters = sum(count_no_psy_patients + count_psy_patients), 
            psy = sum(count_psy_patients),
            percent_psy = round(psy * 100 / total_unique_encounters, 2),
            no_psy = sum(count_no_psy_patients), 
            percent_no_psy = round(no_psy * 100 / total_unique_encounters, 2)
  )
print(total_unique_encounters)
print(chisq.test(total_unique_encounters[, c("psy", "no_psy")]))

```


```{r Extracting age information}

age_table1_all <- table1_all %>% 
  filter(name == "Age" | (name == "Total" & Category == "Sex")) %>% 
  select(name, siteid, before_pandemic, during_pandemic) %>% 
  pivot_longer(cols = c(before_pandemic, during_pandemic), 
               names_to = "period",
               values_to = "values") %>% 
  pivot_wider(names_from = name, 
              values_from = values, 
              id_cols = c(siteid, period)) %>% 
  mutate(mean_age = as.numeric(sub("\\s\\(.*", "", x = Age, perl = TRUE)),
         sd_age = as.numeric(str_extract(pattern = "(?<=\\(sd:\\s)[0-9]{1,2}\\.[0-9]{1,2}(?=\\))", 
                                         string = Age)), 
         Total = as.numeric(sub("\\s\\(.*", "", x = Total, perl = TRUE))
  ) %>% 
  group_by(period) %>% 
  summarise(
    mean_age = round(sum(Total * mean_age) / sum(Total), 2), 
    mean_sd_age = round(sum(Total * sd_age) / sum(Total), 2), 
    ci_age = paste0(" [", round(mean_age - (qnorm(0.975) * mean_sd_age / sum(Total)), 5),
                    " , ",
                    round(mean_age + (qnorm(0.975) * mean_sd_age / sum(Total)), 5), "]")) %>% 
  mutate(Age = paste0(as.character(mean_age), " (sd: ", as.character(mean_sd_age), ")", as.character(ci_age))) %>% 
  select(period, Age) %>% 
  unique() %>%
  pivot_wider(names_from = period, values_from = Age) %>% 
  mutate(Category = "Age", 
         name = "mean (sd), 95% CI") %>% 
  select(Category, name, before_pandemic, during_pandemic) %>% 
  rename(before_pandemic_count = before_pandemic, 
         during_pandemic_count = during_pandemic)
```

```{r}
z_age <- (14.55 - 14.65) / sqrt(1.86^2/9696 + 1.79^2/11101)
pvalue_age <- 2*pnorm(z_age)

```


```{r}
median_table1_all <- length_hospitalisation_values_all %>% 
  group_by(period) %>% 
  summarise(median_hospitalisation = paste0(median(len_hospitalisation),
                                            " (",
                                            IQR(len_hospitalisation), ")"), 
            .groups = "drop") %>% 
  pivot_wider(names_from = period, values_from = median_hospitalisation) %>% 
  mutate(Category = "Length of stays", 
         name = "median") %>% 
  select(Category, name, before_pandemic, during_pandemic) %>% 
  rename(before_pandemic_count = before_pandemic, 
         during_pandemic_count = during_pandemic)
median_table1_all$before_pandemic_count <- as.character(median_table1_all$before_pandemic_count)
median_table1_all$during_pandemic_count <- as.character(median_table1_all$during_pandemic_count)

mean_table1_all <- length_hospitalisation_values_all %>% 
  group_by(period) %>% 
  summarise(mean_hospitalisation = round( mean(len_hospitalisation), 2), 
            conf_interval = gmodels::ci( len_hospitalisation), 
            ci_length = paste0("[", round(as.numeric(conf_interval[2]), 2),
                               " , ",
                               round(as.numeric(conf_interval[3]),2), "]"), 
            .groups = "drop"
            ) %>%
  mutate(mean_hospitalisation = paste0(as.character(mean_hospitalisation), as.character(ci_length))) %>% 
  select(period, mean_hospitalisation) %>%
  unique() %>%
  pivot_wider(names_from = period, values_from = mean_hospitalisation) %>% 
  mutate(Category = "Length of stays", 
         name = "mean [95% CI]") %>% 
  select(Category, name, before_pandemic, during_pandemic) %>% 
  rename(before_pandemic_count = before_pandemic, 
         during_pandemic_count = during_pandemic)
```


```{r}
sex_table1_all <- table1_all %>%
  filter( Category == "Sex" & name != "Total") %>%
  mutate( before_counts = as.numeric(sapply(strsplit( before_pandemic, " "), '[', 1)), 
          during_counts = as.numeric(sapply(strsplit( during_pandemic, " "), '[', 1)), 
          before_total = sum( before_counts ), 
          during_total = sum( during_counts)) %>%
  group_by( name ) %>%
  summarise( before_pandemic_count = sum( as.numeric( before_counts )), 
             during_pandemic_count = sum( as.numeric( during_counts )), 
             before_pandemic_perc  = round(100*before_pandemic_count/before_total, 1), 
             during_pandemic_perc  = round(100*during_pandemic_count/during_total, 1)) %>%
  mutate( Category = "Sex", 
          before_pandemic_count = paste0( before_pandemic_count, " (", before_pandemic_perc, ")"), 
          during_pandemic_count = paste0( during_pandemic_count, " (", during_pandemic_perc, ")")) %>%
  select( Category, name, before_pandemic_count, during_pandemic_count ) %>%
  unique()

dg_table1_all <- table1_all %>%
  filter( Category == "Disorder groups" & name != "Total") %>%
  mutate( before_counts = sapply(strsplit( before_pandemic, " "), '[', 1), 
          during_counts = sapply(strsplit( during_pandemic, " "), '[', 1)) %>%
  group_by( name ) %>%
  summarise( before_pandemic_count = sum( as.numeric( before_counts ), na.rm = TRUE), 
             during_pandemic_count = sum( as.numeric( during_counts ), na.rm = TRUE), 
              before_pandemic_perc  = round(100*before_pandemic_count/9696, 1), 
             during_pandemic_perc  = round(100*during_pandemic_count/10561, 1)) %>%
  mutate( Category = "Disorder groups", 
           before_pandemic_count = paste0( before_pandemic_count, " (", before_pandemic_perc, ")"), 
          during_pandemic_count = paste0( during_pandemic_count, " (", during_pandemic_perc, ")"))%>%
  select( Category, name, before_pandemic_count, during_pandemic_count )

### estimate thhe pvalue for the diosrder groups (chi.sq test)
disorder_group_table_all <- table1_all %>%
  filter( Category == "Disorder groups" & name != "Total") %>%
  mutate( before_counts = sapply(strsplit( before_pandemic, " "), '[', 1), 
          during_counts = sapply(strsplit( during_pandemic, " "), '[', 1)) %>%
  group_by( name ) %>%
  summarise( before_pandemic_yes = sum( as.numeric( before_counts ), na.rm = TRUE), 
             during_pandemic_yes = sum( as.numeric( during_counts ), na.rm = TRUE), 
             before_pandemic_no  = 9696-before_pandemic_yes, 
             during_pandemic_no = 10561- during_pandemic_yes , 
             p_value = chisq.test( matrix( c(before_pandemic_yes, during_pandemic_yes, before_pandemic_no,  during_pandemic_no), ncol = 2, nrow = 2))$p.value, 
             p_value_formated = format.pval(p_value, digits=3, eps=0.001))


p_value_breaks = c(-Inf, 0, 0.0001, 0.001, 0.01, 0.05, Inf)
p_value_labels = c("", "****", "***", "**", "*", "")

setDT(disorder_group_table_all)[, PVAL := cut(p_value,
                                 breaks = p_value_breaks,
                                 right = FALSE,
                                 labels = p_value_labels)]
#####

table1 <- rbind( sex_table1_all, age_table1_all, median_table1_all, mean_table1_all, dg_table1_all )

table1 %>%
  kable( booktabs = T) %>%
  kableExtra::kable_styling(latex_options = "striped") %>%
  kableExtra::group_rows(index = setNames(rle(table1$Category)[[1]], rle(table1$Category)[[2]]))
```


## Interrupted Time Series Analysis 

### Calculate LR coefficients

```{r}
# Estimating regression slopes from linear regression ('observed coefficients')
coefficient_slope_calculation <- function(df, slope_name = "periodduring_pandemic:time", ...) {
  ts_linear_percent <- lm(percentage ~ period * time, df)
  broom::tidy(ts_linear_percent) %>%
    filter(term %in% c(slope_name)) %>% 
    select(term, estimate)
} 

observed_coefficients_df <- patient_count_psy_period_psy_all %>% 
  group_by(siteid) %>% 
  group_modify(coefficient_slope_calculation,
               slope_name = c("time", "periodduring_pandemic:time")
               ) %>% 
  rename(observed_slope_coefficient = estimate) %>% 
  pivot_wider(names_from = term,
              values_from = observed_slope_coefficient) %>% 
  rename(before_slope = time, 
         difference_slope = `periodduring_pandemic:time`) %>% 
  mutate(during_slope = before_slope + difference_slope) %>% 
  pivot_longer(cols = c(before_slope, difference_slope, during_slope), 
               names_to = "term", 
               values_to = "observed_slope_coefficient")
```

### Define bootstrap functions 

```{r}
bootstrap_size <- 10000
binom_proportion <- function(n, prob, size) {
  (rbinom(n, size, prob) / size) * 100
}

bootstrapping_slopes <- function(df,
                                 group_name,
                                 bootstrap_size,
                                 count = "count_icd",
                                 percentage = "percentage") {
  bootstrapped_timepoints <- mapply(
    binom_proportion,
    n = bootstrap_size,
    size = as.integer(df[[count]]),
    prob = df[[percentage]]/100)
  bootstrapped_sample_list <- vector(mode = "list", length = bootstrap_size)
  bootstrapped_coefficients_list <- vector(mode = "list", length = bootstrap_size)
  for (iteration in 1:bootstrap_size) {
    df_iteration <- data.frame(period = df$period,
                               time = df$time,
                               time_p = df$time_p,
                               percentage = bootstrapped_timepoints[iteration, ])
    ts_linear_percent <- lm(as.formula(paste0(percentage, "~ period * time")), df_iteration)
    linear_model <- broom::tidy(ts_linear_percent) %>%
      filter(term %in% c("time", "periodduring_pandemic:time"))
    coefficients <- linear_model$estimate
    names(coefficients) <- linear_model$term
    bootstrapped_coefficients_list[[iteration]] <- coefficients
    # To be able to fill the gap in the subsequent graphs
    df_extended_prediction <- data.frame(
      period = c("before_pandemic", "before_pandemic", "during_pandemic", "during_pandemic"), 
      time = c(1.5, 15.5, 15.5, 28.5), 
      time_p = NA,
      percentage = NA
    )
    df_iteration <- bind_rows(df_iteration, df_extended_prediction)
    df_iteration$predicted <- predict(ts_linear_percent, newdata = df_iteration)
    bootstrapped_sample_list[[iteration]] <- df_iteration
  }
  bootstrapped_fitted_df <- bind_rows(bootstrapped_sample_list, .id = "iteration") %>%
    bind_cols(group_name)
  bootstrapped_coefficients_df <- bind_rows(bootstrapped_coefficients_list,
                                            .id = "iteration") %>%
    bind_cols(group_name)
  return(list(bootstrapped_coefficients_df,
              bootstrapped_fitted_df))
}
```

```{r}
bootstrap_pvalue_calculation <- function(df, ...) {
  z <- unique(df[["observed_slope_coefficient"]]) / sd(df[["bootstrapped_slope_coefficient"]])
  pvalue_coeff_interaction <- round(pnorm(abs(z), lower.tail = FALSE) * 2, 3)
  pvalue_coeff_interaction <- ifelse( pvalue_coeff_interaction >= 0.01, round( pvalue_coeff_interaction, 2), pvalue_coeff_interaction)
  data.frame(
    "pvalue" = pvalue_coeff_interaction,
    "observed_slope_coefficient" = round(unique(df[["observed_slope_coefficient"]]), 2)
  )
}
```



#### Calculate bootstrap: primary analysis

```{r}

bootstrapped <- patient_count_psy_period_psy_all %>%
  group_by(siteid) %>% 
  group_map( ~bootstrapping_slopes(.x, group_name = .y, bootstrap_size = bootstrap_size))
names(bootstrapped) <- unique(patient_count_psy_period_psy_all$siteid)

bootstrapped_coefficients_all <- lapply(bootstrapped, `[[`, 1) %>% 
  bind_rows() %>% 
  rename(before_slope = time, 
         difference_slope = `periodduring_pandemic:time`) %>% 
  mutate(during_slope = before_slope + difference_slope) %>% 
  select(iteration, siteid, everything()) %>% 
    pivot_longer(cols = c(before_slope, difference_slope, during_slope), 
               names_to = "term", 
               values_to = "bootstrapped_slope_coefficient") %>% 
  left_join(observed_coefficients_df, by = c("siteid", "term"))

pvalues_boot <- bootstrapped_coefficients_all %>% 
  group_by(siteid, term) %>% 
  group_modify( bootstrap_pvalue_calculation, .keep = TRUE) %>% 
  mutate(label = paste0("",
                        observed_slope_coefficient,
                        "% (p-value: ",
                        format.pval(pvalue, digits = 2, eps = 10**-2), ")")
  )

ci_boot <- bootstrapped_coefficients_all %>% 
  group_by(siteid, term) %>% 
  summarise("2.5%" = quantile(bootstrapped_slope_coefficient, 0.025), 
            "50%" = quantile(bootstrapped_slope_coefficient, 0.50), 
            "97.5%" = quantile(bootstrapped_slope_coefficient, 0.975)) %>% 
  mutate(ci = paste0("(95% CI ", as.character(format(round(`2.5%`, 2)), nsmall =2), "–", as.character(format(round(`97.5%`, 2)), nsmall=2), ")"))

  
bootstrapped_fitted_all <- lapply(bootstrapped, `[[`, 2) %>% 
  bind_rows() %>%
  left_join(country_map, by = "siteid")

quantile_bootstrapped_fitted_all <- bootstrapped_fitted_all %>%
  group_by(time_p, time, period, siteid) %>%
  summarise("2.5%" = quantile(predicted, 0.025),
            "50%" = median(predicted, 0.5),
            "97.5%" = quantile(predicted, 0.975), 
            .groups = "drop") %>%
  pivot_longer(cols = c("2.5%", "50%", "97.5%"),
               names_to = "quantiles") %>% 
  left_join(country_map, by = "siteid")


```


## Table with bootstrapped coefficients, and pvalues


```{r}
pvalues_boot_complete <- pvalues_boot %>% 
  inner_join(ci_boot, by = c("siteid", "term")) %>% 
  inner_join(country_map, by = c("siteid")) %>% 
  arrange(plotsLabel) %>% 
  #mutate(string = paste0(observed_slope_coefficient, "% ", ci, " (p-value ", format.pval(pvalue, digits = 3, eps = 10**-2), ")")) %>%
  mutate(string = paste0(observed_slope_coefficient, "% ", ci)) %>%
  select(siteid, term, plotsLabel, string) %>% 
  pivot_wider(names_from = term, values_from = string) %>% 
  select(siteid, plotsLabel, before_slope, during_slope, difference_slope) %>% 
  rename("Before pandemic trend [95% CI] (p-value)" = before_slope,
        "Since pandemic trend [95% CI] (p-value)" = during_slope,
        "Difference before/since pandemic trend [95% CI] (p-value)" = difference_slope)

```

#### Primary analysis plot 


```{r}
plot_annotations_df_primary <- pvalues_boot_complete %>%
  select( siteid, label = `Difference before/since pandemic trend [95% CI] (p-value)`, plotsLabel )%>% 
  left_join(country_map, by = c("siteid", "plotsLabel"))
```

```{r}
# Function to change x-axis labels in graphs
time_to_time_p <- function(break_ticks) {
  break_ticks <- as.character(break_ticks)
  sapply(break_ticks, function(break_tick) {
   if (is.na(break_tick) | !break_tick %in% names(time_timep_list)) {
     return(as.Date(NA_character_))
   } else {
     time_timep_list[[break_tick]]
   }
  }) %>%
    as.Date(origin = "1970/01/01") %>% 
    format(format = "%b %Y", tz = "UTC")
}

```


```{r, fig.width = 20, fig.height=14}
bootstrapped_fitted_all %>%
  ggplot(aes(x = time, y = predicted, group = interaction(iteration, period))) +
  facet_wrap("plotsLabel", scales = "free_y", labeller = label_wrap_gen(width = 35,multi_line = TRUE), ncol = 2) +
  geom_line(aes(x = time + 0.5, color = period), alpha = 0.03) +
  geom_line(aes(x = time + 0.5, 
                y = value,
                group = interaction(quantiles, period)),
            data = filter(quantile_bootstrapped_fitted_all, quantiles %in% c("2.5%", "97.5%")),
            linetype = "dashed") +
  geom_line(aes(x = time + 0.5, 
                y = value,
                group = period),
            data = filter(quantile_bootstrapped_fitted_all, quantiles == "50%")) +
  geom_point(aes(x = time + 0.5, y = percentage, group = NULL),
             data = patient_count_psy_period_psy_all,
             alpha = 0.5) +
  scale_x_continuous(breaks = breaks_width(1),
                     labels = time_to_time_p, 
                     limits = c(2, 29),
                     expand = c(0.03,0)) + 
  geom_vline(xintercept = 16, linetype = 6 ) +
  theme(strip.text = element_text(size = 14),
        axis.text.x=element_text(angle = 45, hjust=1, size = 8),
        axis.text.y = element_text(size = 8), 
        axis.title.x =element_blank(),
        axis.title.y = element_text(size = 8),
        panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        title = element_text(size = 14),
        plot.subtitle = element_text(size = 12, face = "italic"), 
        legend.position="bottom") + 
  scale_colour_manual(values = cbPalette, labels = c("pre-pandemic", "pandemic"), name = "Period") +
  geom_label(data = plot_annotations_df_primary, 
             aes(label=label), 
             x = -Inf,
             y = +Inf,
             hjust = 0,
             vjust = 1,
             size = 4,
             inherit.aes = FALSE) +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  labs(
    #title = "Interrupted Time Series Analysis: Percentage of patients with psychiatric conditions",
    #subtitle = "Parametric bootstrap estimation: (10000 iterations)",
       x = "Calendar dates",
       y = "Percentage",
       color = "Period")

ggsave("figure1_boostrapped_all.png", height = 20, width = 25, units = "cm")
```


## Meta-analysis of temporal trends

```{r}
trends_siteid <- bootstrapped_coefficients_all %>% 
  filter(term == "difference_slope") %>% 
  group_by(siteid) %>% 
  summarise(mean_boot = mean(bootstrapped_slope_coefficient),
            observed = unique(observed_slope_coefficient),
            var_boot = var(bootstrapped_slope_coefficient), 
            z = mean_boot / sqrt(var_boot), 
            pvalue = pnorm(z, lower.tail = FALSE)*2 )
```

```{r}
# Random effect
png(file='./figure2A_metaanalysis_persite.png') 

trends_siteid <- trends_siteid %>%
  left_join( country_map )
model_meta_siteid <- metafor::rma(yi = observed, 
                                  vi = var_boot,
                                  measure = "MN",
                                  method = "DL",
                                  data = trends_siteid) 

metafor::forest(model_meta_siteid,
                slab = trends_siteid$plotsLabel,
                plim = c(1, NA),
                order = "obs",
                cex=0.7,
                showweights = TRUE,
                header="Sites",
                xlab = "Mean of the coefficients",
                mlab="Overall effect")
dev.off()
```


```{r}
png(file='figure2B_metaanalysis_country.png') 

trends_country <- trends_siteid %>% 
  group_by(country) %>% 
  group_modify(.f = function(x, ...) {
    as.data.frame(
      predict(rma(yi = observed, 
                vi = var_boot,
                measure = "MN",
                method = "DL",
                data = x))
    )
  },
  .keep = TRUE)

model_meta_country <- rma(data = trends_country, 
                          yi = pred, 
                          vi = se**2, 
                          measure = "MN", 
                          method = "DL")

forest(model_meta_country, 
       slab = trends_country$country,
       plim = c(1, NA),
       order = "obs", 
       showweights = TRUE,
       header = "Countries",
       xlab = "Mean of the coefficients",
       mlab="Overall effect")
dev.off()
```

### Meta analysis with another package

#### Site
```{r}
m.siteid <- metagen(TE = observed,
                 seTE = sqrt( var_boot ),
                 data = trends_siteid,
                 studlab = plotsLabel,
                 sm = "MN",
                 fixed = FALSE,
                 random = TRUE,
                 method.tau = "DL")

summary(m.siteid)

forest.meta(m.siteid, 
            sortvar = TE,
            print.tau2 = FALSE,
            leftlabs = c("plotsLabel"))
forest.meta(m.siteid, layout = "JAMA")

```


#### By country
```{r}
m.country <- metagen(TE = pred,
                 seTE = se,
                 data = trends_country,
                 studlab = country,
                 sm = "MN",
                 fixed = FALSE,
                 random = TRUE,
                 method.tau = "DL")

summary(m.country)

forest.meta(m.country, 
            sortvar = TE,
            print.tau2 = FALSE,
            leftlabs = c("Country"))

forest.meta(m.country, layout = "JAMA")
```


### Sex Summary

```{r, include=FALSE}
patients_hospitalized_agg_sex_total <- patients_hospitalized_agg_sex_perc_all %>%
  select( - percentage ) %>%
  group_by( time_p, time, sex ) %>%
  summarise( total = sum( count ), 
             count_sex = sum( count_sex ), 
             percentage = 100* count_sex / total, 
             siteid = "ALL") %>%  
  mutate(period = ifelse(time_p <= as.Date("2020-03-15"), "before_pandemic", "during_pandemic")) %>% 
  mutate(month_year = format(time_p, "%m")) %>% 
  select(time_p, time, period, sex, count_sex, percentage, siteid, month_year)
```


#### Observed results: disorders

```{r}
observed_coefficients_df_sex <- patients_hospitalized_agg_sex_total %>% 
  group_by(sex) %>% 
  group_modify(coefficient_slope_calculation, 
               slope_name = c("time", "periodduring_pandemic:time")
               ) %>% 
  rename(observed_slope_coefficient = estimate) %>% 
  pivot_wider(names_from = term,
              values_from = observed_slope_coefficient) %>% 
  rename(before_slope = time, 
         difference_slope = `periodduring_pandemic:time`) %>% 
  mutate(during_slope = before_slope + difference_slope) %>% 
  pivot_longer(cols = c(before_slope, difference_slope, during_slope), 
               names_to = "term", 
               values_to = "observed_slope_coefficient")

```


#### Bootstrapping results by sex



```{r }
bootstrapped_sex <- patients_hospitalized_agg_sex_total %>%
  group_by(sex) %>% 
  group_map(~ bootstrapping_slopes(.x,
                                   group_name = .y,
                                   bootstrap_size = bootstrap_size,
                                   count = "count_sex", 
                                   percentage = "percentage"))

bootstrapped_coefficients_sex <- lapply(bootstrapped_sex, `[[`, 1) %>%
  bind_rows() %>% 
  rename(before_slope = time, 
         difference_slope = `periodduring_pandemic:time`) %>% 
  mutate(during_slope = before_slope + difference_slope) %>% 
  select(iteration, sex, everything()) %>% 
  pivot_longer(cols = c(before_slope, difference_slope, during_slope), 
               names_to = "term", 
               values_to = "bootstrapped_slope_coefficient") %>% 
  left_join(observed_coefficients_df_sex, by = c("sex", "term"))


df_coefficients_boot_sex <- bootstrapped_coefficients_sex %>% 
  left_join(observed_coefficients_df_sex, by = c("sex"))


pvalues_boot_sex <- bootstrapped_coefficients_sex %>% 
  group_by(sex, term) %>% 
  group_modify( bootstrap_pvalue_calculation, .keep = TRUE) %>% 
  mutate(label = paste0("",
                        observed_slope_coefficient,
                        "% (p-value: ",
                        format.pval(pvalue, digits = 3, eps = 10**-3), ")")
  )

ci_boot_sex <- bootstrapped_coefficients_sex %>% 
  group_by(sex, term) %>% 
  summarise("2.5%" = quantile(bootstrapped_slope_coefficient, 0.025), 
            "50%" = quantile(bootstrapped_slope_coefficient, 0.50), 
            "97.5%" = quantile(bootstrapped_slope_coefficient, 0.975), 
            .groups = "drop") %>% 
  mutate(ci = paste0("(95% CI ", as.character(round(`2.5%`, 2)), "–", as.character(round(`97.5%`, 2)), ")"))

bootstrapped_fitted_sex <- lapply(bootstrapped_sex, `[[`, 2) %>% bind_rows()

quantile_bootstrapped_fitted_sex <- bootstrapped_fitted_sex %>%
  group_by(time_p, time, period,  sex) %>%
  summarise("2.5%" = quantile(predicted, 0.025),
            "50%" = median(predicted, 0.5),
            "97.5%" = quantile(predicted, 0.975), 
            .groups = "drop") %>%
  pivot_longer(cols = c("2.5%", "50%", "97.5%"),
               names_to = "quantiles")


```
↨
#### Table with bootstrapped coefficients, and pvalues


```{r}
pvalues_boot_sex_complete <- pvalues_boot_sex %>% 
  inner_join(ci_boot_sex, by = c("sex", "term")) %>% 
  arrange(sex) %>% 
  #mutate(string = paste0(observed_slope_coefficient, "% ", ci, " (p-value ", format.pval(pvalue, digits = 3, eps = 10**-2), ")")) %>% 
  mutate(string = paste0(observed_slope_coefficient, "% ", ci)) %>% 
  select(sex, string, term) %>% 
  pivot_wider(names_from = term, values_from = string) %>% 
  select(sex, before_slope, during_slope, difference_slope) %>% 
  rename("Before pandemic trend [95% CI] (p-value)" = before_slope,
        "Since pandemic trend [95% CI] (p-value)" = during_slope,
        "Difference before/since pandemic trend [95% CI] (p-value)" = difference_slope)

pvalues_boot_sex %>% 
  inner_join(ci_boot_sex, by = c("sex", "term")) %>% 
  arrange(sex) %>% 
  mutate(string = paste0(observed_slope_coefficient, " ", ci, " (", format.pval(pvalue, digits = 3, eps = 10**-3), ")")) %>% 
  select(sex, string, term) %>% 
  pivot_wider(names_from = term, values_from = string) %>% 
  select(sex, before_slope, during_slope, difference_slope) %>% 
  rename("Before pandemic trend [95% CI] (p-value)" = before_slope,
        "Since pandemic trend [95% CI] (p-value)" = during_slope,
        "Difference before/since pandemic trend [95% CI] (p-value)" = difference_slope) %>% 
  flextable::flextable() %>% 
  flextable::save_as_docx(path = "table_sex.docx")


```




#### Original plot 


```{r}
plot_annotations_sex_df <- pvalues_boot_sex_complete %>%
  filter( sex == "female") %>% 
    mutate(plotsLabel = "Female") %>%
  select( label = `Difference before/since pandemic trend [95% CI] (p-value)`, plotsLabel, sex)
```



```{r }
bootstrapped_fitted_sex %>% 
  filter( sex == "female") %>%
  ggplot(aes(x = time, y = predicted, group = interaction(iteration, period))) +
  facet_wrap("sex",
             labeller = labeller(sex = c("female" = "Female proportion "))) +
  geom_line(aes(x = time + 0.5, color = period), alpha = 0.01) +
  geom_line(aes(x = time + 0.5, 
                y = value,
                group = interaction(quantiles, period)),
            data = filter(quantile_bootstrapped_fitted_sex, sex == "female" & quantiles %in% c("2.5%", "97.5%")),
            linetype = "dashed") +
  geom_line(aes(x = time + 0.5, 
                y = value,
                group = period),
            data = filter(quantile_bootstrapped_fitted_sex, sex == "female" & quantiles == "50%")) +
  geom_point(aes(x = time + 0.5, y = percentage, group = NULL),
             data = filter(patients_hospitalized_agg_sex_total, sex == "female"),
             alpha = 0.5) +
  scale_x_continuous(breaks = breaks_width(1),
                     labels = time_to_time_p, 
                     limits = c(2, 29),
                     expand = c(0.03,0)) + 
  geom_vline(xintercept = 16, linetype = 6 ) +
  scale_colour_manual(values = cbPalette) +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  scale_colour_manual(values = cbPalette, labels = c("pre-pandemic", "pandemic"), name = "Period") +
  geom_label(data = plot_annotations_sex_df, 
             aes(label=label), 
             x = -Inf,
             y = +Inf,
             hjust = 0,
             vjust = 1,
             size = 4,
             inherit.aes = FALSE) +
  labs(x = "Calendar dates",
       y = "Percentage",
       color = "Period") +
  theme(strip.text = element_text(size = 10),
        axis.text.x=element_text(angle = 45, hjust=1, size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.x =element_blank(),
        axis.title.y = element_text(size = 10),
         panel.grid.minor.x = element_blank(), 
        panel.grid.minor.y = element_blank(),
        title = element_text(size = 14), 
        plot.subtitle = element_text(size = 12, face = "italic"),
        legend.position = "bottom") 

ggsave("figure4_boostrapped_sex.png", height = 15, width = 20, units = "cm")
```

### Alternative plot

```{r bootstrap_plot, include=FALSE, eval = FALSE}
plot_sex <- ggplot(bootstrapped_fitted_sex,
       aes(x = time_p, y = predicted/100, group = interaction(iteration, period, sex))) +
  geom_line(aes(color = interaction(period, sex)),
            alpha = 0.005) +
  geom_line(data = quantile_bootstrapped_fitted_sex,
            aes(y = value/100, group = interaction(quantiles, period, sex)),
            linetype = "dashed") +
  geom_line(data = quantile_bootstrapped_fitted_sex[quantile_bootstrapped_fitted_sex$quantiles == "50%", ],
            aes(y = value/100, group = interaction(period, sex))) +
  geom_point(data = patients_hospitalized_agg_sex_total,
             aes(y = percentage/100, group=sex),
             alpha = 1) +
  scale_color_manual(labels = c("Female", "Male", "", ""),
                     values = c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C")) +
  scale_x_date(breaks = "1 month", labels=date_format("%b %Y"), expand=c(0.03,0))+
  guides(colour = guide_legend(
    override.aes = list(alpha = 1,
                        colour = c('#1F78B4', '#33A02C', NA, NA))) 
  ) +
  annotate("label",
           x = as.Date('2019-10-01'),
           y = 0.69,
           label = "Female proportion [Coefficient difference: 0.77 (pvalue: <0.01)]", 
           fill = "#A6CEE3") +
  annotate("label",
           x = as.Date('2019-10-01'),
           y = 0.3,
           label = "Male proportion [Coefficient difference: -0.77 (pvalue: 0.005)]", 
           fill = "#B2DF8A") +
  labs(
       x = "Calendar dates",
       y = "Sex proportion",
       color = "Sex") +
  ylim(0.25, 0.75) + 
  theme(strip.text = element_text(size = 10),
        axis.text.x=element_text(angle = 45, hjust=1, size = 10),
        axis.text.y = element_text(size = 10),
        axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        title = element_text(size = 14), 
        plot.subtitle = element_text(size = 12, face = "italic"))

plot_sex
ggsave(plot = plot_sex, filename = "figure4_ITS_sex.png", height = 15, width = 20, units = "cm")
```


### Secondary analysis: :disorder group 

```{r}
table_iterations_disorder <- with(perc_disorder_group_all,
  expand.grid(time_p = unique(time_p),
              disorder_group = unique(disorder_group), 
              siteid = unique(siteid)
  )
)

perc_disorder_group_complete <- perc_disorder_group_all %>% 
  full_join(table_iterations_disorder) %>% 
  arrange(siteid, time_p, disorder_group) %>% 
  group_by(siteid, time_p) %>% 
  fill(count_icd, 
       period, 
       country , 
       plotsLabel, 
       .direction = "downup") %>% 
  ungroup() %>% 
  replace_na(list(count_dg = 0, percentage_dg = 0))


disorders_to_select <- c(
  "Anxiety Disorders", 
  "Depressive Disorders", 
  "Feeding and Eating Disorders", 
  "Suicide or Self-Injury"
)


perc_disorder_group_total <- perc_disorder_group_complete %>%
  group_by( time_p, time, disorder_group ) %>%
  summarise( total_diagnoses = sum(count_icd, na.rm = TRUE),
             dg_cases = sum(count_dg),
             percentage = (dg_cases / total_diagnoses) * 100, 
             country = "ALL", 
             siteid = "ALL") %>% 
  mutate(period = ifelse(time_p < pandemic_start_date,
                         "before_pandemic", 
                         "during_pandemic")) %>% 
  filter(disorder_group %in% disorders_to_select)
  
perc_disorder_group_total$disorder_group <- gsub( "Feeding and Eating Disorders", "Eating Disorders", perc_disorder_group_total$disorder_group)

disorders_to_select <- c(
  "Anxiety Disorders", 
  "Depressive Disorders", 
  "Eating Disorders", 
  "Suicide or Self-Injury"
)
```



#### Observed results: disorders

```{r}
observed_coefficients_df_disorder <- perc_disorder_group_total %>% 
  group_by(disorder_group) %>% 
  mutate(month_year = format(time_p, "%m"),
         time = seq_along(time_p))  %>% 
  group_modify(coefficient_slope_calculation, 
               slope_name = c("time", "periodduring_pandemic:time")
               ) %>% 
  rename(observed_slope_coefficient = estimate) %>% 
  pivot_wider(names_from = term,
              values_from = observed_slope_coefficient) %>% 
  rename(before_slope = time, 
         difference_slope = `periodduring_pandemic:time`) %>% 
  mutate(during_slope = before_slope + difference_slope) %>% 
  pivot_longer(cols = c(before_slope, difference_slope, during_slope), 
               names_to = "term", 
               values_to = "observed_slope_coefficient")

```


#### Calculate bootstrap: disorders groups

```{r}

bootstrapped_disorders <- perc_disorder_group_total %>%
  group_by(disorder_group) %>% 
  mutate(month_year = format(time_p, "%m"),
         time = seq_along(time_p))  %>% 
  group_map( ~bootstrapping_slopes(.x,
                                   group_name = .y,
                                   bootstrap_size = bootstrap_size,
                                   count = "dg_cases", 
                                   percentage = "percentage"))
names(bootstrapped_disorders) <- unique(perc_disorder_group_total$disorder_group)

bootstrapped_coefficients_disorders <- lapply(bootstrapped_disorders, `[[`, 1) %>% 
  bind_rows() %>% 
  rename(before_slope = time, 
         difference_slope = `periodduring_pandemic:time`) %>% 
  mutate(during_slope = before_slope + difference_slope) %>% 
  select(iteration, disorder_group, everything()) %>% 
    pivot_longer(cols = c(before_slope, difference_slope, during_slope), 
               names_to = "term", 
               values_to = "bootstrapped_slope_coefficient") %>% 
  left_join(observed_coefficients_df_disorder, by = c("disorder_group", "term"))

pvalues_boot_disorders <- bootstrapped_coefficients_disorders %>% 
  group_by(disorder_group, term) %>% 
  group_modify( bootstrap_pvalue_calculation, .keep = TRUE) %>% 
  mutate(label = paste0("",
                        observed_slope_coefficient,
                        "% (p-value: ",
                        format.pval(pvalue, digits = 2, eps = 10**-2), ")")
  )

ci_boot_disorders <- bootstrapped_coefficients_disorders %>% 
  group_by(disorder_group, term) %>% 
  summarise("2.5%" = quantile(bootstrapped_slope_coefficient, 0.025), 
            "50%" = quantile(bootstrapped_slope_coefficient, 0.50), 
            "97.5%" = quantile(bootstrapped_slope_coefficient, 0.975), 
            .groups = "drop") %>% 
  mutate(ci = paste0("(95% CI ", as.character(round(`2.5%`, 2)), "–", as.character(round(`97.5%`, 2)), ")"))

  
bootstrapped_fitted_disorder <- lapply(bootstrapped_disorders, `[[`, 2) %>% 
  bind_rows() 

quantile_bootstrapped_fitted_disorder <- bootstrapped_fitted_disorder %>%
  group_by(time_p, time, period, disorder_group) %>%
  summarise("2.5%" = quantile(predicted, 0.025),
            "50%" = median(predicted, 0.5),
            "97.5%" = quantile(predicted, 0.975), 
            .groups = "drop") %>%
  pivot_longer(cols = c("2.5%", "50%", "97.5%"),
               names_to = "quantiles") 


```

#### Table coefficients disorders

```{r}
pvalues_boot_disorders_complete <- pvalues_boot_disorders %>% 
  inner_join(ci_boot_disorders, by = c("disorder_group", "term")) %>% 
  arrange(disorder_group) %>% 
  mutate(string = paste0(observed_slope_coefficient, "% ", ci)) %>% 
  select(disorder_group, term, string) %>% 
  pivot_wider(names_from = term, values_from = string) %>% 
  select(disorder_group, before_slope, during_slope, difference_slope) %>% 
  rename("Before pandemic trend [95% CI] (p-value)" = before_slope,
        "Since pandemic trend [95% CI] (p-value)" = during_slope,
        "Difference before/since pandemic trend [95% CI] (p-value)" = difference_slope) 

pvalues_boot_disorders %>% 
  inner_join(ci_boot_disorders, by = c("disorder_group", "term")) %>% 
  arrange(disorder_group) %>% 
  #mutate(string = paste0(observed_slope_coefficient, " ", ci, " (", format.pval(pvalue, digits = 3, eps = 10**-2), ")")) %>% 
  mutate(string = paste0(observed_slope_coefficient, " ", ci)) %>% 
  select(disorder_group, term, string) %>% 
  pivot_wider(names_from = term, values_from = string) %>% 
  select(disorder_group, before_slope, during_slope, difference_slope) %>% 
  rename("Before pandemic trend [95% CI] (p-value)" = before_slope,
        "Since pandemic trend [95% CI] (p-value)" = during_slope,
        "Difference before/since pandemic trend [95% CI] (p-value)" = difference_slope) %>% 
  flextable::flextable() %>% 
  flextable::save_as_docx(path = "table_disorders.docx")

```


```{r}
plot_annotations_disorder_df <-  pvalues_boot_disorders_complete %>%
  select( label = `Difference before/since pandemic trend [95% CI] (p-value)`, disorder_group )
```



```{r, fig.height=15, fig.width=25}
bootstrapped_fitted_disorder %>% 
  mutate(period = recode_factor(period, "before_pandemic" = "Before pandemic onset", "during_pandemic" = "Since pandemic onset")) %>% 
  ggplot(aes(x = time, y = predicted, group = interaction(iteration, period))) +
  facet_wrap("disorder_group",
             scales = "free_y",
             labeller = label_wrap_gen(width = 35,multi_line = TRUE)) +
  geom_line(aes(x = time + 0.5, color = period), alpha = 0.03) +
  geom_line(aes(x = time + 0.5, 
                y = value,
                group = interaction(quantiles, period)),
            data = filter(quantile_bootstrapped_fitted_disorder, quantiles %in% c("2.5%", "97.5%")),
            linetype = "dashed") +
  geom_line(aes(x = time + 0.5, 
                y = value,
                group = period),
            data = filter(quantile_bootstrapped_fitted_disorder, quantiles == "50%")) +
  geom_point(aes(x = time + 0.5, y = percentage, group = NULL),
             data = filter(perc_disorder_group_total, disorder_group %in% disorders_to_select),
             alpha = 0.5) +
  scale_x_continuous(breaks = breaks_width(1),
                     labels = time_to_time_p, 
                     limits = c(2, 29),
                     expand = c(0.03,0)) + 
  geom_vline(xintercept = 16, linetype = 6 ) +
  scale_colour_manual(values = cbPalette, labels = c("pre-pandemic", "pandemic"), name = "Period") +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  geom_label(data = plot_annotations_disorder_df, 
             aes(label=label), 
             x = -Inf,
             y = +Inf,
             hjust = 0,
             vjust = 1,
             size = 4,
             inherit.aes = FALSE) +
  labs(
    #title = "Interrupted Time Series Analysis: Percentage of patients with psychiatric conditions",
    # subtitle = "Parametric bootstrap estimation: (10000 iterations)",
    x = "Calendar dates",
    y = "Percentage",
    color = "Period") +
  theme(strip.text = element_text(size = 10),
        axis.text.x=element_text(angle = 45, hjust=1, size = 8),
        axis.text.y = element_text(size = 8), 
        axis.title.x =element_blank(),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 14),
        plot.subtitle = element_text(size = 8, face = "italic"), 
        legend.position = "bottom") 

ggsave("figure3_boostrapped_disorders.png", height = 15, width = 25, units = "cm")
```



```{r}

percentages_htm <- perc_disorder_group_total %>%
  select( time, time_p, disorder_group, percentage ) %>%
  unique() %>%
  pivot_wider( names_from =  disorder_group, 
               values_from = percentage ) %>% 
  ungroup()

dates <- percentages_htm$time_p 

percentages_htm <- percentages_htm %>% select(-time, -time_p)

counts_htm <- perc_disorder_group_total %>%
  select( time, time_p, disorder_group, dg_cases ) %>%
  unique() %>%
  pivot_wider( names_from =  disorder_group, 
               values_from = dg_cases ) %>% 
  ungroup()
counts_htm <- counts_htm %>% select(-time, -time_p)
tempVariabilityInput <- new('DataTemporalMap', probabilityMap = as.matrix(percentages_htm), 
         countsMap = as.matrix(counts_htm), dates = dates, support = as.data.frame(names(percentages_htm)), 
         variableName = "example", variableType = "character", period = "month")

vline <- function(x = 0, color = "green") {
  list(
    type = "line",
    y0 = 0,
    y1 = 1,
    yref = "paper",
    x0 = x,
    x1 = x,
    line = list(color = color, dash="dot"))
}

fig = plotDataTemporalMap(tempVariabilityInput, absolute = TRUE)

fig <- fig %>%
  layout(
    title = " ",
      yaxis = list(autorange="reversed"), 
    xaxis = list(
      type = 'date',
      tickformat = "%b-%y", 
      tickangle=-45, 
      tickvals=dates), 
    shapes = list(vline(as.Date("2020-03-15"))))

fig
```

### Estimate number of ICD codes per site and disorder group
Represent this in 16 pannels, if we put all together, due to the different scales we will not be able to really see the differences between results. 

```{r}
mental_codes_qc_output_all <- mental_codes_qc_output_all %>%
    mutate( concept_code = gsub("[.]", "", concept_code ) ) %>%
  unique()

numberOfCodesPerDisorderGroup <- mental_codes_qc_output_all %>%
  group_by( disorder_group, siteid ) %>%
  mutate( icd_codes_count = n( )) %>%
  select( disorder_group, siteid, icd_codes_count ) %>%
  unique()

swr = function(string, nwrap=30) {
  paste(strwrap(string, width=nwrap), collapse="\n")
}
swr = Vectorize(swr)

positions <- c("BCH", "CCHMC","CHOP", "UMICH", "Lurie", "FRBDX", "APHP")

numberOfCodesPerDisorderGroup %>%
  left_join( country_map ) %>%
  mutate( disorder_group = swr( disorder_group ) )  %>%
  ggplot( aes( x= siteid, y = icd_codes_count, fill = country )) +
  geom_bar( stat = "identity") +
  scale_fill_manual("Country of each site", values = c("USA" = "navy", "France" = "orange")) +
  facet_wrap( ~ disorder_group, scales = "free" , ncol = 3) +
  labs(x ="site identifier", y = "Number of ICD-10 codes") +
  scale_x_discrete(limits = positions) +
  theme(axis.text.x=element_text(angle=45,hjust=1, size = 11), 
        strip.text = element_text(size = 13), 
        axis.text.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        axis.title.y = element_text(size = 13), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.title=element_text(size=13), 
        legend.text=element_text(size=13), 
        legend.position="bottom") 
ggsave("figure_supp2_ICDdictionaryQC.png", height = 40, width = 45, units = "cm")

```


## ITS with seasonality 


### Total counts with psychiatric conditions and total counts per month

#### At site level
```{r}
library(reshape2)

counts <- patient_count_psy_period_psy_all %>%
  select( plotsLabel, time_p, time, month_year, count_psy_patients, total_cases = count_icd )

counts2 <- reshape2::melt(counts ,  id.vars = c('plotsLabel', 'time_p', 'time','month_year'), variable.name = 'group')
counts2$group <- gsub("count_psy_patients", "Patients with mental health disorder", counts2$group )
counts2$group <- gsub("total_cases", "Total number of patients", counts2$group )


counts_plot <- counts2 %>% ggplot( aes( x= as.Date( time_p ), y = value, group= group )) +
  geom_point( aes( shape= group, color = group )) +
  facet_wrap2("plotsLabel", axes = "all", scales ="free", labeller = label_wrap_gen(width = 35,multi_line = TRUE)) + 
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed") +
  labs(x ="", y = "number of patients")+
  scale_x_date(breaks = "1 month", labels=date_format("%b %Y"), expand=c(0.03,0)) +
  scale_color_manual( values = cbPalette ) + 
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 10), 
        axis.text.y=element_text( size = 10),
        axis.title.y = element_text( size = 9),
        strip.text = element_text(size = 11, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), 
        legend.position="bottom")

counts_plot
ggsave("figure_supp1A_counts_per_site.png", counts_plot, height = 25, width = 40, units = "cm")

```

#### All together
```{r}
counts_agg <- counts %>%
  group_by( time_p ) %>%
  mutate( psy_cases = sum( count_psy_patients), 
    total_cases = sum(total_cases)) %>%
  select( time_p, time, month_year, psy_cases, total_cases)

counts_agg2 <- reshape2::melt(counts_agg ,  id.vars = c('time_p', 'time','month_year'), variable.name = 'group')
counts_agg2$group <- gsub("count_psy_patients", "Patients with mental health disorder", counts_agg2$group )
counts_agg2$group <- gsub("total_cases", "Total number of patients", counts_agg2$group )

counts_agg2plot <- counts_agg2 %>% ggplot( aes( x= as.Date( time_p ), y = value, group= group )) +
  geom_point( aes( shape= group, color = group )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed") +
  labs(x ="", y = "number of patients")+
  scale_x_date(breaks = "1 month", labels=date_format("%b %Y"), expand=c(0.03,0)) +
  scale_color_manual( values = cbPalette ) + 
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 10), 
        axis.text.y=element_text( size = 10),
        axis.title.y = element_text( size = 9),
        strip.text = element_text(size = 11, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), 
        legend.position="bottom")

counts_agg2plot
ggsave("figure_supp1B_counts_all.png",counts_agg2plot, height = 20, width = 32, units = "cm")
```


# Unused figures 



```{r, include = FALSE}
sexInfo_per_country <- table1_all %>%
  filter( Category == "Sex") %>%
  mutate ( counts_before = as.numeric(sapply(strsplit( as.character(before_pandemic), " "), '[', 1)), 
           counts_during = as.numeric(sapply(strsplit( as.character(during_pandemic), " "), '[', 1))) %>%
  select( name, siteid, counts_before, counts_during ) %>%
  inner_join( country_map ) %>%
  group_by( name, country ) %>%
  summarise( before = sum( counts_before), 
             during = sum( counts_during )) %>%
  pivot_longer(names_to = "period", cols=c(before, during)) 
sexInfo_all <- table1_all %>%
  filter( Category == "Sex") %>%
  mutate ( counts_before = as.numeric(sapply(strsplit( as.character(before_pandemic), " "), '[', 1)), 
           counts_during = as.numeric(sapply(strsplit( as.character(during_pandemic), " "), '[', 1))) %>%
  select( name, siteid, counts_before, counts_during ) %>%
  inner_join( country_map ) %>%
  group_by( name ) %>%
  summarise( before = sum( counts_before), 
             during = sum( counts_during )) %>%
  pivot_longer(names_to = "period", cols=c(before, during)) %>%
  mutate( country = 'ALL' ) %>%
  select( name, country, period, value ) %>%
  rbind( sexInfo_per_country)
sexInfo_all %>%
  ggplot( aes( x= name, y = value, fill = period )) +
  geom_bar( stat = "identity", position = "dodge") +
  facet_wrap("country", scales = "free_y") + 
  labs(x ="", y = "number of patients") +
  theme(axis.text.x=element_text(hjust=1, size = 8), 
        strip.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA))+ 
  scale_fill_manual("Pandemic \n period", values = c("before" = "grey", "during" = "orange"))


```



```{r, include=FALSE}
patients_hospitalized_agg_sex_total %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = sex )) +
  geom_line( aes( linetype = sex , color = sex)) +
  geom_point( aes( shape = sex, color = sex )) +
  scale_colour_manual(values=c("#FF6600","#339999")) +
  scale_fill_manual(values=c("#FF6600","#339999"))+
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed")+
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b %Y"), expand=c(0.03,0))+
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA))
  
```

