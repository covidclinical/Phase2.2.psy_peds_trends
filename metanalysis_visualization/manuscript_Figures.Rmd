---
title: "Visualizations for the manuscript"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---


### Installing packages and loading the library

```{r libraries, message=FALSE, warning=FALSE, results='hide'}
# Install packages
paket <- function(pak){
  new_pak <- pak[!(pak %in% rownames(installed.packages()))]
  if (length(new_pak)) 
    install.packages(new_pak, dependencies = TRUE,repos="https://cloud.r-project.org/")
  sapply(pak, library, character.only = TRUE)
}
listOfPackages <- c("tidyverse", "tidyr","devtools","RColorBrewer", "knitr", "kableExtra", "tsModel", "gridExtra", "dplyr", "metafor", "meta", "viridis", "UpSetR", "scales", "EHRtemporalVariability", "plotly")
paket(listOfPackages)

if (! "ComplexHeatmap" %in% rownames(installed.packages())) install_github("jokergoo/ComplexHeatmap")
if (! "ggh4x" %in% rownames(installed.packages())) install_github("teunbrand/ggh4x")
library( ComplexHeatmap)
library( ggh4x )
```


```{r}
# options(repr.plot.width = 18, repr.plot.height = 9)
theme_plots <- theme_bw() +
  theme(strip.text = element_text(size = 5),
        axis.text.x = element_text(size = 8), 
        axis.text.y = element_text(size = 6), 
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 10),
        plot.subtitle = element_text(size = 9, face = "italic")) 
theme_set(theme_plots)

# Colorblind palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

```{r}
# cut-off dates used in the analysis, these should not be changed
time_period <-"months" #possible values: days, weeks, months
#history_start_date <- as.Date("2019-01-01")
#history_end_date <- as.Date("2021-05-31")
pandemic_start_date <- as.Date("2020-03-15")
start_date_plots <- as.Date("2019-01-01")
end_date_plots <- as.Date("2021-05-31")
```

## Read the input file by site
Each site shared the aggregated counts results. Putting all the results together. 

```{r}
outputDir <- "../../output/latest_output/"
outputFiles <- list.files( path = outputDir, pattern = "\\.RData")
country_map <- read.delim( file = "../public-data/country_mapping.txt")
```

Put all the aggregated counts from the different sites together
```{r}
for( i in 1:length( outputFiles )){
  print(outputFiles[i])
  load(paste0( outputDir, outputFiles[i]))
  if( i == 1 ){
    count_icd_all <- count_icd
    patients_hospitalized_agg_sex_perc_all <- patients_hospitalized_agg_sex_perc
    patient_count_psy_period_psy_all <- patient_count_psy_period_psy
    perc_disorder_group_all <- perc_disorder_group
    ratios_patients_with_without_psy_all <- ratios_patients_with_without_psy
    bootstrapped_fitted_all <- bootstrapped_fitted_df
    bootstrapped_coefficients_all <- bootstrapped_coefficients_df
    length_hospitalisation_values_all <- length_hospitalisation_values
    mental_codes_qc_output_all <- mental_codes_qc_output %>%
      select( disorder_group, description, concept_code, distinct_patients, distinct_observations, siteid )
    table1_all <- table1
  } else {
    count_icd_all <- rbind(count_icd_all, count_icd)
    perc_disorder_group_all <- rbind(perc_disorder_group_all, perc_disorder_group)
    patients_hospitalized_agg_sex_perc_all <- rbind( patients_hospitalized_agg_sex_perc_all, patients_hospitalized_agg_sex_perc)
    mental_codes_qc_output_all <- rbind( mental_codes_qc_output_all,
                                         mental_codes_qc_output %>%
                                           select( disorder_group, description, concept_code, distinct_patients, distinct_observations, siteid )
    )
    table1_all <- rbind( table1_all, table1)
    patient_count_psy_period_psy_all <- rbind( patient_count_psy_period_psy_all,patient_count_psy_period_psy)
    ratios_patients_with_without_psy_all <- rbind( ratios_patients_with_without_psy_all, ratios_patients_with_without_psy)
    bootstrapped_fitted_all <- rbind(bootstrapped_fitted_all, bootstrapped_fitted_df)
    bootstrapped_coefficients_all <- rbind(bootstrapped_coefficients_all, bootstrapped_coefficients_df)
    length_hospitalisation_values_all <- tryCatch(
      rbind(length_hospitalisation_values_all, length_hospitalisation_values),
      error = function(e) length_hospitalisation_values_all
    )
    rm(count_icd,patients_hospitalized_agg_sex_perc,patient_count_psy_period_psy,
       perc_disorder_group,ratios_patients_with_without_psy,
       patient_count_psy_period_psy_clear, bootstrapped_coefficients_df,
       bootstrapped_fitted_df, mental_codes_qc_output, table1, length_hospitalisation_values)
  }
}

```

# Filter by dates
```{r}
start_date_plots <- as.Date("2019-01-01")
end_date_plots <- as.Date("2021-05-31")

filter_by_dates <- function(df_,
                            start_date_plot,
                            end_date_plots) {
  df_[df_[["time_p"]] <= end_date_plots & df_[["time_p"]] >= start_date_plots, ]
}

bootstrapped_fitted_all <- filter_by_dates(bootstrapped_fitted_all, start_date_plots, end_date_plots)
count_icd_all <- filter_by_dates(count_icd_all, start_date_plots, end_date_plots)
patient_count_psy_period_psy_all <- filter_by_dates(patient_count_psy_period_psy_all, start_date_plots, end_date_plots)
patients_hospitalized_agg_sex_perc_all <- filter_by_dates(patients_hospitalized_agg_sex_perc_all, start_date_plots, end_date_plots)
perc_disorder_group_all <- filter_by_dates(perc_disorder_group_all, start_date_plots, end_date_plots)
ratios_patients_with_without_psy_all <- filter_by_dates(ratios_patients_with_without_psy_all, start_date_plots, end_date_plots)
```

# Add site complete name information

```{r}
bootstrapped_fitted_all <- left_join(bootstrapped_fitted_all, country_map, on = "site_id")
count_icd_all <- left_join(count_icd_all, country_map, on = "site_id")
patient_count_psy_period_psy_all <- left_join(patient_count_psy_period_psy_all, country_map, on = "site_id")
patients_hospitalized_agg_sex_perc_all <- left_join(patients_hospitalized_agg_sex_perc_all, country_map, on = "site_id")
perc_disorder_group_all <- left_join(perc_disorder_group_all, country_map, on = "site_id")
ratios_patients_with_without_psy_all <- left_join(ratios_patients_with_without_psy_all, country_map, on = "site_id")

```


### Table 1

```{r Extracting age information}
age_table1_all <- table1_all %>% 
  filter(name == "Age" | (name == "Total" & Category == "Sex")) %>% 
  select(name, siteid, before_pandemic, during_pandemic) %>% 
  pivot_longer(cols = c(before_pandemic, during_pandemic), 
               names_to = "period",
               values_to = "values") %>% 
  pivot_wider(names_from = name, 
              values_from = values, 
              id_cols = c(siteid, period)) %>% 
  mutate(mean_age = as.numeric(sub("\\s\\(.*", "", x = Age, perl = TRUE)),
         sd_age = as.numeric(str_extract(pattern = "(?<=\\(sd:\\s)[0-9]{1,2}\\.[0-9]{1,2}(?=\\))", 
                                         string = Age)),
         Total = as.numeric(sub("\\s\\(.*", "", x = Total, perl = TRUE))
  ) %>% 
  group_by(period) %>% 
  summarise(mean_age = round(sum(Total * mean_age) / sum(Total), 2), 
            sd_age = round(sum(Total * sd_age) / sum(Total), 2)) %>% 
  mutate(Age = paste0(as.character(mean_age), " (sd: ", as.character(sd_age), ")")) %>% 
  select(period, Age) %>% 
  pivot_wider(names_from = period, values_from = Age) %>% 
  mutate(Category = "Age", 
         name = "mean (sd)") %>% 
  select(Category, name, before_pandemic, during_pandemic) %>% 
  rename(before_pandemic_count = before_pandemic, 
         during_pandemic_count = during_pandemic)
```


```{r}
median_table1_all <- length_hospitalisation_values_all %>% 
  filter(siteid != "CCHMC") %>% # temporary
  group_by(period) %>% 
  summarise(median_hospitalisation = median(len_hospitalisation)) %>% 
  pivot_wider(names_from = period, values_from = median_hospitalisation) %>% 
  mutate(Category = "Length of stays", 
         name = "median") %>% 
  select(Category, name, before_pandemic, during_pandemic) %>% 
  rename(before_pandemic_count = before_pandemic, 
         during_pandemic_count = during_pandemic)
```


```{r}
sex_table1_all <- table1_all %>%
  filter( Category == "Sex" & name != "Total") %>%
  mutate( before_counts = sapply(strsplit( before_pandemic, " "), '[', 1), 
          during_counts = sapply(strsplit( during_pandemic, " "), '[', 1)) %>%
  group_by( name ) %>%
  summarise( before_pandemic_count = sum( as.numeric( before_counts )), 
             during_pandemic_count = sum( as.numeric( during_counts ))) %>%
  mutate( Category = "Sex") %>%
  select( Category, name, before_pandemic_count, during_pandemic_count )

sex_table1_all <- rbind( sex_table1_all, c("Total", "",sum( sex_table1_all$before_pandemic_count), sum( sex_table1_all$during_pandemic_count)))

dg_table1_all <- table1_all %>%
  filter( Category == "Disorder groups" & name != "Total") %>%
  mutate( before_counts = sapply(strsplit( before_pandemic, " "), '[', 1), 
          during_counts = sapply(strsplit( during_pandemic, " "), '[', 1)) %>%
  group_by( name ) %>%
  summarise( before_pandemic_count = sum( as.numeric( before_counts ), na.rm = TRUE), 
             during_pandemic_count = sum( as.numeric( during_counts ), na.rm = TRUE)) %>%
  mutate( Category = "Disorder groups") %>%
  select( Category, name, before_pandemic_count, during_pandemic_count )

table1 <- rbind( sex_table1_all, age_table1_all, median_table1_all, dg_table1_all )

table1 %>%
  kable( booktabs = T) %>%
  kableExtra::kable_styling(latex_options = "striped") %>%
  kableExtra::group_rows(index = setNames(rle(table1$Category)[[1]], rle(table1$Category)[[2]]))
```


## Interrupted Time Series Analysis 


```{r}
# Recovering
coefficient_slope_calculation <- function(df, ...) {
  ts_linear_percent <- lm(percentage ~ period * time, df)
  linear_model <- broom::tidy(ts_linear_percent) %>%
    filter(term %in% c("periodduring_pandemic:time"))
} 
  
coefficients_df <- patient_count_psy_period_psy_all %>% 
  group_by(siteid) %>% 
  group_modify(coefficient_slope_calculation) %>% 
  rename(observed_diff = estimate)
```

## Define bootstrap functions 

```{r}
# Call function from another file : bootstrap.R
bootstrap_size <- 1000
binom_proportion <- function(n, prob, size) {
  (rbinom(n, size, prob) / size) * 100
}


bootstrapping_slopes <- function(df,
                                 group_name,
                                 bootstrap_size,
                                 count = "count_icd",
                                 percentage = "percentage") {
  bootstrapped_timepoints <- mapply(
    binom_proportion,
    n = bootstrap_size,
    size = df[[count]],
    prob = df[[percentage]]/100)
  bootstrapped_sample_list <- vector(mode = "list", length = bootstrap_size)
  bootstrapped_coefficients_list <- vector(mode = "list", length = bootstrap_size)
  for (iteration in 1:bootstrap_size) {
    df_iteration <- data.frame(period = df$period,
                               time = df$time,
                               percentage = bootstrapped_timepoints[iteration, ])
    ts_linear_percent <- lm(as.formula(paste0(percentage, "~ period * time")), df_iteration)
    linear_model <- broom::tidy(ts_linear_percent) %>%
      filter(term %in% c("time", "periodduring_pandemic:time"))
    coefficients <- linear_model$estimate
    names(coefficients) <- linear_model$term
    bootstrapped_coefficients_list[[iteration]] <- coefficients
    df_iteration$predicted <- predict(ts_linear_percent)
    df_iteration$time_p <- df$time_p
    bootstrapped_sample_list[[iteration]] <- df_iteration
  }
  bootstrapped_fitted_df <- bind_rows(bootstrapped_sample_list, .id = "iteration") %>%
    bind_cols(group_name)
  bootstrapped_coefficients_df <- bind_rows(bootstrapped_coefficients_list,
                                            .id = "iteration") %>%
    bind_cols(group_name)
  return(list(bootstrapped_coefficients_df,
              bootstrapped_fitted_df))
}
```


```{r}
# Get count_icd_all in the same format that patient_count_psy_period_psy_all, because first n last months missing ... 
count_icd_all_boot <- count_icd_all %>% 
  group_by(siteid) %>% # necessary to generate time correctly 
  rename(percentage = percentage_psy) %>% 
  mutate(month_year = format(time_p, "%m"),
         time = seq_along(time_p))
  
bootstrapped <- count_icd_all_boot %>%
  group_by(siteid) %>% 
  group_map( ~bootstrapping_slopes(.x, group_name = .y, bootstrap_size = bootstrap_size))
names(bootstrapped) <- unique(count_icd_all_boot$siteid)

bootstrapped_coefficients_all <- lapply(bootstrapped, `[[`, 1) %>% bind_rows()
bootstrapped_fitted_all <- lapply(bootstrapped, `[[`, 2) %>% bind_rows()
```


### Primary analysis 

```{r}
annotation_function <- function(df, ...) {
  z <- unique(df[["observed_diff"]]) / sd(df[["periodduring_pandemic:time"]])
  pvalue_coeff_interaction <- round(pnorm(abs(z), lower.tail = FALSE) * 2, 3)
  paste0("Coeffs differences: ",
         round(unique(df[["observed_diff"]]), 2),
         " (pvalue: ",
         format.pval(pvalue_coeff_interaction),
         ")")
}
```

```{r}
quantile_bootstrapped_fitted_all <- bootstrapped_fitted_all %>%
  group_by(time_p, period, siteid) %>%
  summarise("2.5%" = quantile(predicted, 0.025),
            "50%" = median(predicted, 0.5),
            "97.5%" = quantile(predicted, 0.975)) %>%
  pivot_longer(cols = c("2.5%", "50%", "97.5%"),
               names_to = "quantiles")
```


```{r}
df_coefficients_boot <- bootstrapped_coefficients_all %>% 
  left_join(coefficients_df, by = "siteid") %>% 
  left_join(country_map, by = "siteid")

names_site_id <- unique(df_coefficients_boot$plotsLabel)

plot_annotations <- df_coefficients_boot %>% 
  group_by(plotsLabel) %>% 
  group_map( annotation_function ) %>% 
  set_names(names_site_id) %>% 
  unlist()
plot_annotations_df <- data.frame(
  plotsLabel = names(plot_annotations), 
  label = plot_annotations
)
```


```{r}
bootstrapped_fitted_all <- bootstrapped_fitted_all %>% left_join(country_map, by = "siteid")

quantile_bootstrapped_fitted_all <- quantile_bootstrapped_fitted_all %>% left_join(country_map, by = "siteid")
```


```{r}
ggplot(bootstrapped_fitted_all, aes(x = time_p, y = predicted, group = interaction(iteration, period))) +
  facet_wrap("plotsLabel", scales = "free_y", labeller = label_wrap_gen(width = 35,multi_line = TRUE)) +
  geom_line(aes(color = period),
            alpha = 0.03) +
  geom_line(data = quantile_bootstrapped_fitted_all,
            aes(y = value, group = interaction(quantiles, period)),
            linetype = "dashed") +
  geom_line(data = quantile_bootstrapped_fitted_all[quantile_bootstrapped_fitted_all$quantiles == "50%", ],
            aes(y = value, group = period)) +
  geom_point(data = patient_count_psy_period_psy_all,
             aes(y = percentage, group=NULL),
             alpha = 0.5) +
  scale_colour_manual(values = cbPalette) +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  geom_label(data = plot_annotations_df, 
             aes(label=label), 
            x = -Inf,
            y = +Inf,
            hjust = 0,
            vjust = 1,
            size = 4,
            inherit.aes = FALSE) +
  labs(title = "Interrupted Time Series Analysis: Percentage of patients with psychiatric conditions",
       subtitle = "Parametric bootstrap estimation: (1000 iterations)",
       x = "Calendar dates",
       y = "Percentage",
       color = "Period") +
  theme(strip.text = element_text(size = 10),
        axis.text.x = element_text(size = 8), 
        axis.text.y = element_text(size = 8), 
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 14),
        plot.subtitle = element_text(size = 12, face = "italic")) 
ggsave("boostrapped_all.png", height = 20, width = 32, units = "cm")
```


## Meta-analysis of temporal trends

```{r}
trends_siteid <- df_coefficients_boot %>% 
  group_by(plotsLabel) %>% 
  summarise(mean_boot = mean(`periodduring_pandemic:time`),
            observed = unique(observed_diff),
            var_boot = var(`periodduring_pandemic:time`), 
            z = mean_boot / sqrt(var_boot), 
            pvalue = pnorm(z, lower.tail = FALSE)*2 )
```

```{r}
# Random effect
model_meta_siteid <- metafor::rma(yi = observed, 
                                  vi = var_boot,
                                  measure = "MN",
                                  method = "DL",
                                  data = trends_siteid) 

metafor::forest(model_meta_siteid,
                slab = trends_siteid$plotsLabel,
                plim = c(1, NA),
                order = "obs",
                cex=0.7,
                showweights = TRUE,
                header="Sites",
                mlab="Overall periods' slope differences")
```


```{r}
trends_country <- trends_siteid %>% 
  group_by(plotsLabel) %>% 
  group_modify(.f = function(x, ...) {
    as.data.frame(
      predict(rma(yi = observed, 
                vi = var_boot,
                measure = "MN",
                method = "DL",
                data = x))
    )
  },
  .keep = TRUE)

model_meta_country <- rma(data = trends_country, 
                          yi = pred, 
                          vi = se**2, 
                          measure = "MN", 
                          method = "DL")

forest(model_meta_country, 
       slab = trends_country$plotsLabel,
       plim = c(1, NA),
       order = "obs", 
       showweights = TRUE,
       header = "Countries",
       mlab = "Overall periods' slope differences")
```


### Sex Summary

```{r}
sexInfo_per_country <- table1_all %>%
  filter( Category == "Sex") %>%
  mutate ( counts_before = as.numeric(sapply(strsplit( as.character(before_pandemic), " "), '[', 1)), 
           counts_during = as.numeric(sapply(strsplit( as.character(during_pandemic), " "), '[', 1))) %>%
  select( name, siteid, counts_before, counts_during ) %>%
  inner_join( country_map ) %>%
  group_by( name, country ) %>%
  summarise( before = sum( counts_before), 
             during = sum( counts_during )) %>%
  pivot_longer(names_to = "period", cols=c(before, during)) 
sexInfo_all <- table1_all %>%
  filter( Category == "Sex") %>%
  mutate ( counts_before = as.numeric(sapply(strsplit( as.character(before_pandemic), " "), '[', 1)), 
           counts_during = as.numeric(sapply(strsplit( as.character(during_pandemic), " "), '[', 1))) %>%
  select( name, siteid, counts_before, counts_during ) %>%
  inner_join( country_map ) %>%
  group_by( name ) %>%
  summarise( before = sum( counts_before), 
             during = sum( counts_during )) %>%
  pivot_longer(names_to = "period", cols=c(before, during)) %>%
  mutate( country = 'ALL' ) %>%
  select( name, country, period, value ) %>%
  rbind( sexInfo_per_country)
sexInfo_all %>%
  ggplot( aes( x= name, y = value, fill = period )) +
  geom_bar( stat = "identity", position = "dodge") +
  facet_wrap("country", scales = "free_y") + 
  labs(x ="", y = "number of patients") +
  theme(axis.text.x=element_text(hjust=1, size = 8), 
        strip.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA))+ 
  scale_fill_manual("Pandemic \n period", values = c("before" = "grey", "during" = "orange"))


```


```{r}
patients_hospitalized_agg_sex_total <- patients_hospitalized_agg_sex_perc_all %>%
  select( - percentage ) %>%
  group_by( time_p, sex ) %>%
  summarise( total = sum( count ), 
             count_sex = sum( count_sex ), 
             percentage = 100* count_sex / total, 
             siteid = "ALL")

patients_hospitalized_agg_sex_total %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = sex )) +
  geom_line( aes( linetype = sex , color = sex)) +
  geom_point( aes( shape = sex, color = sex )) +
  scale_colour_manual(values=c("#FF6600","#339999")) +
  scale_fill_manual(values=c("#FF6600","#339999"))+
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed")+
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0))+
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA))
  
```


```{r Interrupted time series by sex}

patients_hospitalized_agg_sex_total <- patients_hospitalized_agg_sex_total %>% 
  mutate(period = ifelse(time_p <= as.Date("2020-03-15"), "before_pandemic", "during_pandemic")) %>% 
  select(time_p, period, sex, count_sex, percentage, siteid)
# %>% 
#   inner_join(country_map)

bootstrapped_sex <- patients_hospitalized_agg_sex_total %>%
  group_by(sex) %>% 
  # group_by(plotsLabel, sex) %>% 
  mutate(month_year = format(time_p, "%m"),
         time = seq_along(time_p))  %>% 
 group_map(~ bootstrapping_slopes(.x,
                                  group_name = .y,
                                  bootstrap_size = bootstrap_size,
                                  count = "count_sex", 
                                  percentage = "percentage"))

bootstrapped_coefficients_sex <- lapply(bootstrapped_sex, `[[`, 1) %>% bind_rows()
bootstrapped_fitted_sex <- lapply(bootstrapped_sex, `[[`, 2) %>% bind_rows()
```


```{r Interrupted time series by sex 2}
quantile_bootstrapped_fitted_sex <- bootstrapped_fitted_sex %>%
  # group_by(time_p, period, plotsLabel, sex) %>%
  group_by(time_p, period,  sex) %>%
  summarise("2.5%" = quantile(predicted, 0.025),
            "50%" = median(predicted, 0.5),
            "97.5%" = quantile(predicted, 0.975)) %>%
  pivot_longer(cols = c("2.5%", "50%", "97.5%"),
               names_to = "quantiles")
```

```{r}
coefficients_df_sex <- patients_hospitalized_agg_sex_total %>% 
  group_by(sex) %>% 
  # group_by(plotsLabel, sex) %>% 
    mutate(month_year = format(time_p, "%m"),
         time = seq_along(time_p))  %>% 
  group_modify(coefficient_slope_calculation) %>% 
  rename(observed_diff = estimate)

```


```{r}
df_coefficients_boot_sex <- bootstrapped_coefficients_sex %>% 
  # left_join(coefficients_df_sex, by = c("plotsLabel", "sex"))
  left_join(coefficients_df_sex, by = c("sex"))
```

```{r}
names_sex <- unique(df_coefficients_boot_sex$sex)


## Using only male, but female and male necessarily yield equal p-values
plot_annotations_sex_df <- annotation_function(
  df_coefficients_boot_sex[df_coefficients_boot_sex$sex == "female", ]
) %>% data.frame(label = ., 
                 plotsLabel = "Female")

# plot_annotations_sex_df <- df_coefficients_boot_sex %>% 
#   group_by(sex) %>% 
#   group_map(annotation_function) %>%
#   paste(str_to_title(names_sex), ., sep = ": ") %>% 
#   as_tibble() %>% 
#   rename(label = value)
# bind_cols(group_names) %>% 
#                rename(label = value) %>% 
#                mutate(label = paste(stringr::str_to_title(sex), label, sep = ": ")) %>% 
#                mutate(plotsLabel = names_site_id)
#              , .keep = TRUE) %>% 
  # group_map( function(df, group_names) group_by(df, plotsLabel) %>%
  #              annotation_function() %>%
               # as_tibble() %>%
               # bind_cols(group_names) %>%
               # rename(label = value) %>%
               # mutate(label = paste(stringr::str_to_title(sex), label, sep = ": ")) %>%
  #              mutate(plotsLabel = names_site_id)
  #            , .keep = TRUE) %>% 
  # set_names(unique(df_coefficients_boot_sex$sex))


```



```{r bootstrap_plot}
ggplot(bootstrapped_fitted_sex, aes(x = time_p, y = predicted, group = interaction(iteration, period, sex))) +
  # facet_wrap("plotsLabel", scales = "free_y", labeller = label_wrap_gen(width = 35,multi_line = TRUE)) +
  geom_line(aes(color = interaction(period, sex)),
            alpha = 0.03) +
  geom_line(data = quantile_bootstrapped_fitted_sex,
            aes(y = value, group = interaction(quantiles, period, sex)),
            linetype = "dashed") +
  geom_line(data = quantile_bootstrapped_fitted_sex[quantile_bootstrapped_fitted_sex$quantiles == "50%", ],
            aes(y = value, group = interaction(period, sex))) +
  geom_point(data = patients_hospitalized_agg_sex_total,
             aes(y = percentage, group=sex, color = interaction(period, sex)),
             alpha = 1) +
  scale_color_brewer(palette = "Paired") +
  # scale_colour_manual(values = c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C")) +
  guides(color = guide_legend(override.aes = list(alpha = 1))) +
  geom_label(data = plot_annotations_sex_df,
             aes(label=label),
            x = -Inf,
            y = +Inf,
            hjust = 0,
            vjust = 1,
            size = 4,
            inherit.aes = FALSE) +
  # geom_label(data = plot_annotations_sex_df[["male"]],
  #            aes(label=label),
  #            x = -Inf,
  #            y = 15,
  #            hjust = 0,
  #            vjust = 0,
  #            size = 4,
  #           inherit.aes = FALSE) +
  # ylim(10, 90) +
  labs(title = "Interrupted Time Series Analysis: Percentage of patients with psychiatric conditions",
  subtitle = "Parametric bootstrap estimation: (1000 iterations)",
       x = "Calendar dates",
       y = "Percentage",
       color = "Period") +
  theme(strip.text = element_text(size = 10),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 14),
  plot.subtitle = element_text(size = 12, face = "italic"))
```
### Disorder group fix 

```{r}
table_iterations_disorder <- with(perc_disorder_group_all,
  expand.grid(time_p = unique(time_p),
              disorder_group = unique(disorder_group), 
              siteid = unique(siteid)
  )
)

perc_disorder_group_complete <- perc_disorder_group_all %>% 
  full_join(table_iterations_disorder) %>% 
  arrange(siteid, time_p, disorder_group) %>% 
  group_by(siteid, time_p) %>% 
  fill(count_icd, 
       period, 
       country , 
       plotsLabel, 
       .direction = "downup") %>% 
  ungroup() %>% 
  replace_na(list(count_dg = 0, percentage_dg = 0))

perc_disorder_group_total_fix <- perc_disorder_group_complete %>%
  group_by( time_p, disorder_group ) %>%
  summarise( total_diagnoses = sum(count_icd, na.rm = TRUE),
             sum_dg_psy = sum(count_dg),
             percentage = (sum_dg_psy / total_diagnoses) * 100, 
             country = "ALL") 

```



### Disorder group 
```{r}
perc_disorder_group_total_first <- perc_disorder_group_all %>%
  select( - percentage_dg ) %>%
  group_by( time_p, disorder_group ) %>%
  mutate( total_cases = sum( count_icd, na.rm = TRUE ), 
          dg_cases = sum( count_dg ), 
          percentage = 100* dg_cases / total_cases, 
          country = "ALL") 

perc_disorder_group_total_first %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = disorder_group )) +
  facet_wrap( ~ disorder_group, scales = "free" ) +
  geom_line( aes(color = disorder_group )) +
  geom_point( aes( color = disorder_group )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed")+
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0))+
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA))


percentages_htm <- perc_disorder_group_total_first %>%
  select( time_p, disorder_group, percentage ) %>%
  unique() %>%
  pivot_wider( names_from =  disorder_group, 
               values_from = percentage )

dates <- percentages_htm$time_p 

percentages_htm <- percentages_htm[  , -1]

counts_htm <- perc_disorder_group_total_first %>%
  select( time_p, disorder_group, dg_cases ) %>%
  unique() %>%
  pivot_wider( names_from =  disorder_group, 
               values_from = dg_cases )
counts_htm <- counts_htm[  , -1]

tempVariabilityInput <- new('DataTemporalMap', probabilityMap = as.matrix(percentages_htm), 
         countsMap = as.matrix(counts_htm), dates = dates, support = as.data.frame(names(percentages_htm)), 
         variableName = "example", variableType = "character", period = "month")

vline <- function(x = 0, color = "green") {
  list(
    type = "line",
    y0 = 0,
    y1 = 1,
    yref = "paper",
    x0 = x,
    x1 = x,
    line = list(color = color, dash="dot"))
}

fig = plotDataTemporalMap(tempVariabilityInput, absolute = TRUE)

fig <- fig %>%
  layout(
    title = " ",
    xaxis = list(
      type = 'date',
      tickformat = "%b-%y", 
      tickangle=-45, 
      tickvals=dates), 
    shapes = list(vline(as.Date("2020-03-15"))))

fig

#### facet wrap in 3 groups based on %
### most prevalent
perc_disorder_group_total_first %>%
  filter(disorder_group %in% c("Anxiety Disorders", "Depressive Disorders", "Suicide or Self-Injury" ))  %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = country )) +
  facet_wrap( ~ disorder_group ) +
  geom_line( aes(color = country )) +
  geom_point( aes( color = country )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed")+
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0))+
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA)) +
  scale_color_manual( values = cbPalette )

#medium prevalent
perc_disorder_group_total_first %>%
  filter(disorder_group %in% c("Trauma and Stressor-Related Disorders", "Mental Health Symptom", "Disruptive, Impulse Control and Conduct Disorders", 
                               "Feeding and Eating Disorders"))  %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = country )) +
  facet_wrap( ~ disorder_group ) +
  geom_line( aes(color = country )) +
  geom_point( aes( color = country )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed")+
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0))+
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA)) +
  scale_color_manual( values = cbPalette )


#low prevalent
perc_disorder_group_total_first %>%
  filter(disorder_group %in% c("Miscellaneous", "Substance-Related and Addictive Disorders", 
                               "Personality Disorders", "Bipolar and Related Disorders", "Sleep-Wake Disorders", 
                               "Schizophrenia Spectrum and Other Psychotic Disorders", "Somatic Symptom and Related Disorders", 
                               "Obsessive-Compulsive and Related Disorders", "Dissociative Disorders" ))  %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = country )) +
  facet_wrap( ~ disorder_group ) +
  geom_line( aes(color = country )) +
  geom_point( aes( color = country )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed")+
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0))+
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA)) +
  scale_color_manual( values = cbPalette )



perc_disorder_group_total_first %>%
  filter(disorder_group %in% c("Anxiety Disorders", "Depressive Disorders", "Suicide or Self-Injury" ))  %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = country )) +
  facet_wrap( ~ disorder_group ) +
  geom_line( aes(color = country )) +
  geom_point( aes( color = country )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed") +
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0)) +
  scale_color_manual( values = cbPalette ) + 
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6), 
        strip.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), 
        legend.position="bottom")

perc_disorder_group_total_first %>%
  filter( disorder_group %in% c("Anxiety Disorders", "Depressive Disorders", "Suicide or Self-Injury", 
  "Mental Health Symptoms", "Feeding and Eating Disorders" )) %>%
  ggplot( aes( x= as.Date( time_p ), y = percentage, group = country )) +
  geom_line( aes(linetype = country, color = country )) +
  geom_point( aes( shape= country, color = country )) +
  #scale_y_continuous(breaks = seq(0, 30, by = 5)) +
  facet_wrap2("disorder_group", axes = "all", scales ="free") + 
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed") +
  labs(x ="", y = "percentage of patients (%)")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0)) +
  scale_color_manual( values = cbPalette ) + 
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6), 
        strip.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), 
        legend.position="bottom")
  
```

### Estimate number of ICD codes per site and disorder group
Represent this in 16 pannels, if we put all together, due to the different scales we will not be able to really see the differences between results. 
```{r}
mental_codes_qc_output_all <- mental_codes_qc_output_all %>%
    mutate( concept_code = gsub("[.]", "", concept_code ) ) %>%
  unique()

numberOfCodesPerDisorderGroup <- mental_codes_qc_output_all %>%
  group_by( disorder_group, siteid ) %>%
  mutate( icd_codes_count = n( )) %>%
  select( disorder_group, siteid, icd_codes_count ) %>%
  unique()

swr = function(string, nwrap=30) {
  paste(strwrap(string, width=nwrap), collapse="\n")
}
swr = Vectorize(swr)

positions <- c("BCH", "CCHMC","CHOP", "UMICH", "Lurie", "FRBDX", "APHP")

numberOfCodesPerDisorderGroup %>%
  left_join( country_map ) %>%
  mutate( disorder_group = swr( disorder_group ) )  %>%
  ggplot( aes( x= siteid, y = icd_codes_count, fill = country )) +
  geom_bar( stat = "identity") +
  scale_fill_manual("Country of each site", values = c("USA" = "navy", "France" = "orange")) +
  facet_wrap( ~ disorder_group, scales = "free" ) +
  labs(x ="site identifier", y = "ICD dictionary (number of ICD codes)") +
  scale_x_discrete(limits = positions) +
  theme(axis.text.x=element_text(angle=45,hjust=1, size = 6), 
        strip.text = element_text(size = 7), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position="bottom") 
```


## ITS with seasonality 


### By site
```{r}
head(patient_count_psy_period_psy_all)
sites <- unique( patient_count_psy_period_psy_all$siteid )
source("../metanalysis_visualization/time_series_analysis_plotting.R")
p <- list()

for( i in 1:length(sites)){
  print(i)
  subset_site <- patient_count_psy_period_psy_all %>%
    filter( siteid == sites[i])
  ts_seasonal_percent_per_site <- lm(percentage ~ period*time + harmonic(month_year, 1, 12), subset_site)
  p[[i]] <- time_series_analysis_plotting(ts_seasonal_percent_per_site,
                              subset_site,
                              "percentage",
                              clearance_period = FALSE) +
  labs(title = sites[i],
       x = "Calendar dates",
       y = "Percentage") +
      scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0)) +
     theme(strip.text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, hjust=1, size = 8), 
        axis.text.y = element_text(size = 8), 
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        title = element_text(size = 14),
        plot.subtitle = element_text(size = 12, face = "italic"))

}

g <- do.call(grid.arrange,p)
ggsave("its_seasonality_site.png",g, height = 20, width = 32, units = "cm")

```


### Total counts with psychiatric conditions and total counts per month

#### At site level
```{r}
library(reshape2)

counts <- count_icd_all %>%
  mutate( time = seq_along(time_p),
         month_year = format(time_p, "%m")) %>%
  select( plotsLabel, time_p, time, month_year, count_psy_patients = count_psy, total_cases = count_icd )

counts2 <- reshape2::melt(counts ,  id.vars = c('plotsLabel', 'time_p', 'time','month_year'), variable.name = 'group')
counts2$group <- gsub("count_psy_patients", "patients with psychiatric conditions", counts2$group )
counts2$group <- gsub("total_cases", "total number of patients", counts2$group )


counts_plot <- counts2 %>% ggplot( aes( x= as.Date( time_p ), y = value, group= group )) +
  geom_point( aes( shape= group, color = group )) +
  facet_wrap2("plotsLabel", axes = "all", scales ="free", labeller = label_wrap_gen(width = 35,multi_line = TRUE)) + 
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed") +
  labs(x ="", y = "number of patients")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0)) +
  scale_color_manual( values = cbPalette ) + 
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6), 
        strip.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), 
        legend.position="bottom")
counts_plot
ggsave("counts_plot.png",counts_plot, height = 20, width = 32, units = "cm")

```

#### All together
```{r}
counts_agg <- counts %>%
  group_by( time_p ) %>%
  mutate( psy_cases = sum( count_psy_patients), 
    total_cases = sum(total_cases)) %>%
  select( time_p, time, month_year, psy_cases, total_cases)

counts_agg2 <- reshape2::melt(counts_agg ,  id.vars = c('time_p', 'time','month_year'), variable.name = 'group')
counts_agg2$group <- gsub("count_psy_patients", "patients with psychiatric conditions", counts_agg2$group )
counts_agg2$group <- gsub("total_cases", "total number of patients", counts_agg2$group )


counts_agg2 %>% ggplot( aes( x= as.Date( time_p ), y = value, group= group )) +
  geom_point( aes( shape= group, color = group )) +
  geom_vline(xintercept = as.Date(pandemic_start_date), linetype = "dashed") +
  labs(x ="", y = "number of patients")+
  scale_x_date(breaks = "1 month", labels=date_format("%b-%y"), expand=c(0.03,0)) +
  scale_color_manual( values = cbPalette ) + 
  theme(axis.text.x=element_text(angle = 45, hjust=1, size = 6), 
        strip.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), 
        legend.position="bottom")
```

